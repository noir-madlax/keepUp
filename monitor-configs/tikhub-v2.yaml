###################################################################################
# TikHub Account Balance ç›‘æ§é…ç½® (Version 2.0)
###################################################################################
# ä¸šåŠ¡è¯´æ˜ï¼š
#   æœ¬é…ç½®ç”¨äºç›‘æ§ TikHub.io å¹³å°çš„è´¦æˆ·ä½™é¢
#   TikHub æ˜¯ TikTok æ•°æ®APIæœåŠ¡æä¾›å•†ï¼ŒæŒ‰é‡è®¡è´¹
#   è´¦æˆ·ä½™é¢ç”¨äºè°ƒç”¨å„ç§ TikTok æ•°æ®API
#
# ç›‘æ§ç›®çš„ï¼š
#   - å®æ—¶è·Ÿè¸ªè´¦æˆ·ä½™é¢
#   - ç›‘æ§æ¯æ—¥æ¶ˆè€—æƒ…å†µ
#   - åŠæ—¶å……å€¼ï¼Œé¿å…æœåŠ¡ä¸­æ–­
#
# é¡µé¢ç‰¹å¾ï¼š
#   - URL: https://user.tikhub.io/en-us/users/overview
#   - è®¤è¯è¦æ±‚ï¼šéœ€è¦ç™»å½•çŠ¶æ€ï¼ˆé€šè¿‡ Cookieï¼‰
#   - é¡µé¢æŠ€æœ¯æ ˆï¼šä¼ ç»ŸæœåŠ¡ç«¯æ¸²æŸ“ + TailwindCSS
#   - åçˆ¬æªæ–½ï¼šCloudflare ä¿æŠ¤ï¼ˆå¯èƒ½éœ€è¦ç­‰å¾…éªŒè¯é€šè¿‡ï¼‰
#   - æ•°æ®æ›´æ–°é¢‘ç‡ï¼šå®æ—¶
#   - å…³é”®æŒ‡æ ‡ï¼šAccount Balanceã€Today's Cost
###################################################################################

name: "TikHub"
site_id: "tikhub"
url: "https://user.tikhub.io/en-us/users/overview"
description: "ç›‘æ§ TikHub TikTok æ•°æ® API æœåŠ¡çš„è´¦æˆ·ä½™é¢"
icon_url: "https://tikhub.io/favicon.ico"

# ä¸šåŠ¡é‡è¦æ€§é…ç½®
priority: "medium"  # high/medium/low
alert_threshold:
  low_balance: 5.0  # å½“ä½™é¢ä½äº $5 æ—¶å‘Šè­¦
  critical_balance: 1.0  # å½“ä½™é¢ä½äº $1 æ—¶ç´§æ€¥å‘Šè­¦
  daily_cost_high: 2.0  # å½“æ—¥æ¶ˆè€—è¶…è¿‡ $2 æ—¶å‘Šè­¦

###################################################################################
# æµè§ˆå™¨ç¯å¢ƒé…ç½®
###################################################################################
browser_config:
  viewport:
    width: 1920
    height: 1080
  
  # User-Agentï¼šæ¨¡æ‹ŸçœŸå®çš„ macOS Chrome æµè§ˆå™¨
  # é‡è¦ï¼šTikHub ä½¿ç”¨ Cloudflare ä¿æŠ¤ï¼Œéœ€è¦çœŸå®çš„æµè§ˆå™¨ç‰¹å¾
  user_agent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
  
  # é¢å¤–çš„æµè§ˆå™¨è®¾ç½®ï¼ˆç»•è¿‡ Cloudflareï¼‰
  extra_http_headers:
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"
    "Accept-Language": "en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7"
    "Accept-Encoding": "gzip, deflate, br"
    "Connection": "keep-alive"
    "Upgrade-Insecure-Requests": "1"
    "Sec-Fetch-Dest": "document"
    "Sec-Fetch-Mode": "navigate"
    "Sec-Fetch-Site": "none"
    "Sec-Fetch-User": "?1"
    "Cache-Control": "max-age=0"
  
  timeouts:
    navigation: 45000  # å¢åŠ åˆ° 45 ç§’ï¼ˆç­‰å¾… Cloudflare éªŒè¯ï¼‰
    wait_for_selector: 20000  # å¢åŠ åˆ° 20 ç§’
    cloudflare_check: 15000  # Cloudflare éªŒè¯ä¸“ç”¨è¶…æ—¶
    screenshot: 5000

###################################################################################
# é¡µé¢è®¿é—®ä¸æ•°æ®æå–æ­¥éª¤
###################################################################################
steps:
  # ============================================================================
  # æ­¥éª¤ 1: å¯¼èˆªåˆ° Overview é¡µé¢
  # ============================================================================
  - step_id: "nav_to_overview"
    action: "navigate"
    url: "https://user.tikhub.io/en-us/users/overview"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   è®¿é—® TikHub çš„ç”¨æˆ· Dashboard Overview é¡µé¢
    #   æ­¤é¡µé¢æ˜¾ç¤ºè´¦æˆ·ä½™é¢ã€ä»Šæ—¥æ¶ˆè€—ã€ç­¾åˆ°ç­‰ä¿¡æ¯
    
    # æŠ€æœ¯éš¾ç‚¹ï¼š
    #   TikHub ä½¿ç”¨ Cloudflare ä¿æŠ¤ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹æƒ…å†µï¼š
    #   1. Cloudflare éªŒè¯é¡µé¢ï¼ˆ"Checking your browser..."ï¼‰
    #   2. Cloudflare Challengeï¼ˆéœ€è¦äººå·¥äº¤äº’ï¼‰
    #   3. ç›´æ¥è®¿é—®æˆåŠŸ
    
    # ç­‰å¾…ç­–ç•¥ï¼š
    #   ä½¿ç”¨ 'domcontentloaded' è€Œä¸æ˜¯ 'networkidle'
    #   åŸå› ï¼šCloudflare éªŒè¯é¡µé¢å¯èƒ½æœ‰æŒç»­çš„ç½‘ç»œè¯·æ±‚
    
    config:
      wait_until: "domcontentloaded"  # DOM åŠ è½½å®Œæˆå³å¯
      timeout: 45000  # å……è¶³çš„æ—¶é—´ç­‰å¾… Cloudflare éªŒè¯
    
    validation:
      - type: "url_contains"
        value: "/users/overview"
        error_message: "é¡µé¢å¯¼èˆªå¤±è´¥ï¼šæœªèƒ½è·³è½¬åˆ° Overview é¡µé¢"
      
      # æ³¨æ„ï¼šä¸éªŒè¯ HTTP çŠ¶æ€ç 
      # åŸå› ï¼šCloudflare éªŒè¯é¡µé¢å¯èƒ½è¿”å› 403 æˆ–å…¶ä»–çŠ¶æ€ç 

  # ============================================================================
  # æ­¥éª¤ 2: ç­‰å¾… Cloudflare éªŒè¯é€šè¿‡
  # ============================================================================
  - step_id: "wait_for_cloudflare"
    action: "wait_for_element"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   ç­‰å¾… Cloudflare éªŒè¯å®Œæˆï¼Œç¡®ä¿èƒ½çœ‹åˆ°çœŸå®é¡µé¢å†…å®¹
    #   éªŒè¯é€šè¿‡çš„æ ‡å¿—ï¼šå‡ºç° TikHub çš„é¡µé¢å…ƒç´ 
    
    # Cloudflare éªŒè¯è¯†åˆ«ï¼š
    #   éªŒè¯ä¸­ï¼šé¡µé¢åŒ…å« "Checking your browser..." æˆ– "Just a moment..."
    #   éªŒè¯é€šè¿‡ï¼šå‡ºç°æ­£å¸¸çš„é¡µé¢å…ƒç´ ï¼ˆå¦‚ "Account Balance"ï¼‰
    
    # é¡µé¢ç»“æ„åˆ†æï¼ˆéªŒè¯é€šè¿‡åï¼‰ï¼š
    #   - ä¾§è¾¹æ ï¼šåŒ…å« "TikHub*Data" logo
    #   - ä¸»å†…å®¹åŒºï¼šåŒ…å«ä½™é¢å¡ç‰‡å’Œå…¶ä»–ä¿¡æ¯
    #   - ç‰¹å¾æ–‡æœ¬ï¼š"Check In"ã€"Account Balance"
    
    selectors:
      # ä¸»é€‰æ‹©å™¨ï¼šAccount Balance æ ‡é¢˜
      # è¿™æ˜¯éªŒè¯é€šè¿‡åçš„æ˜ç¡®æ ‡å¿—
      primary: "div.stat-title:has-text('Account Balance')"
      
      # å¤‡ç”¨é€‰æ‹©å™¨ï¼š
      fallback:
        - "text=/Check In|Account Balance/"  # æ­£åˆ™åŒ¹é…å…³é”®æ–‡æœ¬
        - "div.stat"  # ç»Ÿè®¡å¡ç‰‡å®¹å™¨
        - "section:has-text('TikHub')"  # TikHub logo åŒºåŸŸ
    
    config:
      timeout: 20000  # æœ€å¤šç­‰å¾… 20 ç§’
      visible: true  # å…ƒç´ å¿…é¡»å¯è§
      
      # å¦‚æœç­‰å¾…è¶…æ—¶ï¼Œå¯èƒ½é‡åˆ°ä»¥ä¸‹æƒ…å†µï¼š
      #   1. Cloudflare Challengeï¼ˆéœ€è¦äººå·¥äº¤äº’ï¼‰
      #   2. Cookie å·²å¤±æ•ˆï¼ˆæœªç™»å½•ï¼‰
      #   3. ç½‘ç«™ç»“æ„å˜æ›´
    
    on_failure:
      action: "check_cloudflare"  # ç‰¹æ®Šå¤„ç†ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ Cloudflare é—®é¢˜
      
      # æ£€æŸ¥é¡µé¢å†…å®¹
      check_content:
        # å¦‚æœé¡µé¢åŒ…å«è¿™äº›æ–‡æœ¬ï¼Œè¯´æ˜æ˜¯ Cloudflare Challenge
        cloudflare_indicators:
          - "Checking your browser"
          - "Just a moment"
          - "Enable JavaScript"
          - "Ray ID"
          - "cloudflare"
        
        # å¤„ç†ç­–ç•¥ï¼š
        on_cloudflare_detected:
          action: "abort"
          reason: "cloudflare_challenge"
          message: "Cloudflare äººæœºéªŒè¯è§¦å‘ï¼Œè¯·å°è¯•ä½¿ç”¨æ›´çœŸå®çš„æµè§ˆå™¨ç‰¹å¾æˆ–æ‰‹åŠ¨è®¿é—®ä¸€æ¬¡"
          notify: true
      
      # å¦‚æœä¸æ˜¯ Cloudflare é—®é¢˜ï¼Œå¯èƒ½æ˜¯ Cookie å¤±æ•ˆ
      check_login:
        login_indicators:
          - "text=/Sign In|Log In|Login/"
          - "input[type='email']"
          - "input[type='password']"
        
        on_login_required:
          action: "abort"
          reason: "cookie_expired"
          message: "ç™»å½•çŠ¶æ€å¤±æ•ˆï¼Œè¯·æ›´æ–° Cookie"
          notify: true

  # ============================================================================
  # æ­¥éª¤ 3: éªŒè¯ç™»å½•çŠ¶æ€
  # ============================================================================
  - step_id: "verify_login"
    action: "wait_for_element"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   éªŒè¯ç”¨æˆ·å·²æˆåŠŸç™»å½•
    #   TikHub çš„å·²ç™»å½•æ ‡å¿—ï¼š
    #   - ä¾§è¾¹æ æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    #   - å¯ä»¥çœ‹åˆ° "Check In" æŒ‰é’®
    #   - å¯ä»¥çœ‹åˆ° "Account Balance" å¡ç‰‡
    
    selectors:
      # ä¸»é€‰æ‹©å™¨ï¼šAccount Balance å¡ç‰‡
      primary: "div.stat:has(div.stat-title:has-text('Account Balance'))"
      
      # å¤‡ç”¨é€‰æ‹©å™¨ï¼š
      fallback:
        - "div.stat-value"  # ä½™é¢æ•°å€¼å…ƒç´ 
        - "button:has-text('Check In')"  # ç­¾åˆ°æŒ‰é’®ï¼ˆä»…ç™»å½•ç”¨æˆ·å¯è§ï¼‰
    
    config:
      timeout: 10000
      visible: true
    
    on_failure:
      action: "abort"
      reason: "cookie_expired"
      message: "ç™»å½•çŠ¶æ€éªŒè¯å¤±è´¥ï¼šå¯èƒ½ Cookie å·²è¿‡æœŸæˆ–é¡µé¢ç»“æ„å˜æ›´"

  # ============================================================================
  # æ­¥éª¤ 4: æå– Account Balanceï¼ˆè´¦æˆ·ä½™é¢ï¼‰
  # ============================================================================
  - step_id: "extract_account_balance"
    action: "extract"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   æå–å½“å‰è´¦æˆ·ä½™é¢
    #   è¿™æ˜¯ç›‘æ§çš„æ ¸å¿ƒæ•°æ®
    
    # é¡µé¢ç»“æ„åˆ†æï¼ˆåŸºäºå®é™… HTMLï¼‰ï¼š
    #   <div class="stat">
    #     <div class="stat-title">Account Balance</div>
    #     <div class="stat-value my-4">$9.0416</div>  â† ç›®æ ‡æ•°æ®
    #     <div style="display: flex; align-items: center;">
    #       <div class="stat-desc">Total Cost Today:</div>
    #       <div class="stat-desc">$0.0020</div>
    #     </div>
    #   </div>
    
    # æå–ç­–ç•¥ï¼š
    #   æ–¹æ¡ˆ 1ï¼šé€šè¿‡ class="stat-value" ç›´æ¥æå–ï¼ˆæ¨èï¼‰
    #   æ–¹æ¡ˆ 2ï¼šé€šè¿‡æ–‡æœ¬åŒ¹é…æå–
    
    target:
      field_name: "account_balance"
      field_type: "currency"
      field_description: "TikHub è´¦æˆ·ä½™é¢"
    
    extraction:
      # æå–æ–¹æ³• 1ï¼šé€šè¿‡ CSS é€‰æ‹©å™¨ï¼ˆæ¨èï¼‰
      - method: "text"
        
        # é€‰æ‹©å™¨ï¼šç²¾ç¡®å®šä½åˆ°ä½™é¢æ•°å€¼
        # ç‰¹å¾ï¼š
        #   - class="stat-value"
        #   - åœ¨åŒ…å« "Account Balance" çš„ .stat å®¹å™¨å†…
        #   - class="my-4" (margin-y: 1rem)
        selector: "div.stat:has(div.stat-title:has-text('Account Balance')) div.stat-value"
        
        # å¤‡ç”¨é€‰æ‹©å™¨ï¼šæ›´ç®€å•çš„æ–¹å¼
        fallback_selector: ".stat-value"
        
        # æ­£åˆ™è¡¨è¾¾å¼è¯´æ˜ï¼š
        #   \$?(\d+(?:\.\d+)?)
        #   - \$?             â†’ å¯é€‰çš„ç¾å…ƒç¬¦å·
        #   - \d+            â†’ æ•´æ•°éƒ¨åˆ†ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªæ•°å­—ï¼‰
        #   - (?:\.\d+)?     â†’ å¯é€‰çš„å°æ•°éƒ¨åˆ†
        #     \.            â†’ å°æ•°ç‚¹
        #     \d+           â†’ å°æ•°æ•°å­—
        #   - ()             â†’ æ•è·ç»„ï¼ˆæå–çš„å†…å®¹ï¼‰
        regex: "\\$?\\s*(\\d+(?:\\.\\d+)?)"
        regex_group: 1
        
        # æ•°æ®è½¬æ¢ï¼šå­—ç¬¦ä¸² â†’ æµ®ç‚¹æ•°
        transform: "float"
        
        # æ•°æ®éªŒè¯ï¼š
        validation:
          min_value: 0.0  # ä½™é¢æœ€å°å€¼ï¼š0
          max_value: 1000.0  # ä½™é¢æœ€å¤§å€¼ï¼š1000ï¼ˆåˆç†èŒƒå›´ï¼‰
          decimal_places: 4  # å°æ•°ä½æ•°ï¼šæœ€å¤š 4 ä½
      
      # æå–æ–¹æ³• 2ï¼šé€šè¿‡æ­£åˆ™åŒ¹é…å…¨æ–‡ï¼ˆå¤‡ç”¨ï¼‰
      - method: "text"
        selector: "body"  # ä»æ•´ä¸ªé¡µé¢æå–
        
        # æ›´å®½æ¾çš„æ­£åˆ™ï¼šåŒ¹é… "Account Balance" åé¢çš„æ•°å­—
        regex: "Account Balance[\\s\\S]*?\\$\\s*(\\d+(?:\\.\\d+)?)"
        regex_group: 1
        transform: "float"
        
        # å¤‡ç”¨æ–¹æ¡ˆä¼˜å…ˆçº§æ›´ä½
        priority: "fallback"
    
    # æå–æˆåŠŸåçš„å¤„ç†ï¼š
    on_success:
      add_timestamp: true
      timestamp_field: "balance_checked_at"
      
      # æ£€æŸ¥ä½™é¢æ˜¯å¦ä½äºé˜ˆå€¼
      check_threshold: true
    
    # æå–å¤±è´¥åçš„å¤„ç†ï¼š
    on_failure:
      action: "retry"
      max_retries: 3
      retry_delay: 2000
      
      # é‡è¯•å¤±è´¥åè®°å½•è¯¦ç»†é”™è¯¯
      final_action: "log"
      error_field: "balance_extraction_error"
      
      # ä¿å­˜é¡µé¢ HTML ç”¨äºè°ƒè¯•
      save_html: true
      html_field: "error_html_snapshot"

  # ============================================================================
  # æ­¥éª¤ 5: æå– Today's Costï¼ˆä»Šæ—¥æ¶ˆè€—ï¼‰
  # ============================================================================
  - step_id: "extract_daily_cost"
    action: "extract"
    optional: true  # å¯é€‰æ­¥éª¤ï¼Œå¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   æå–ä»Šæ—¥çš„ API è°ƒç”¨æ¶ˆè€—
    #   ç”¨äºåˆ†æä½¿ç”¨è¶‹åŠ¿å’Œæˆæœ¬æ§åˆ¶
    
    # é¡µé¢ç»“æ„åˆ†æï¼š
    #   <div style="display: flex; align-items: center;">
    #     <div class="stat-desc">Total Cost Today:</div>
    #     <div class="stat-desc">$0.0020</div>  â† ç›®æ ‡æ•°æ®
    #   </div>
    
    target:
      field_name: "daily_cost"
      field_type: "currency"
      field_description: "ä»Šæ—¥æ¶ˆè€—é‡‘é¢"
    
    extraction:
      - method: "text"
        
        # é€‰æ‹©å™¨ï¼šå®šä½åˆ°åŒ…å« "Total Cost Today" çš„å®¹å™¨
        # ç„¶åæå–å…¶ä¸­çš„ç¬¬äºŒä¸ª .stat-descï¼ˆå³æ•°å€¼ï¼‰
        selector: |
          div:has(div.stat-desc:has-text('Total Cost Today'))
          div.stat-desc:nth-of-type(2)
        
        # å¤‡ç”¨é€‰æ‹©å™¨ï¼šé€šè¿‡æ–‡æœ¬åŒ¹é…
        fallback_selector: "text=/Total Cost Today:[\\s\\S]*?(\\$[\\d.]+)/"
        
        # æ­£åˆ™æå–
        regex: "\\$?\\s*(\\d+(?:\\.\\d+)?)"
        regex_group: 1
        transform: "float"
        
        validation:
          min_value: 0.0
          max_value: 100.0  # å•æ—¥æ¶ˆè€—é€šå¸¸ä¸è¶…è¿‡ $100
    
    on_success:
      # è®¡ç®—é¢„è®¡æœˆåº¦æ¶ˆè€—
      calculate:
        - field: "estimated_monthly_cost"
          formula: "daily_cost * 30"
          description: "é¢„è®¡æœˆåº¦æ¶ˆè€—ï¼ˆåŸºäºä»Šæ—¥æ¶ˆè€—ï¼‰"
    
    # å¦‚æœæå–å¤±è´¥ï¼Œä¸å½±å“æ•´ä½“æµç¨‹
    on_failure:
      action: "skip"
      log_warning: "ä»Šæ—¥æ¶ˆè€—æ•°æ®æå–å¤±è´¥ï¼Œè·³è¿‡æ­¤æ­¥éª¤"

  # ============================================================================
  # æ­¥éª¤ 6: æˆªå–é¡µé¢æˆªå›¾
  # ============================================================================
  - step_id: "capture_screenshot"
    action: "screenshot"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   ä¿å­˜ Overview é¡µé¢çš„æˆªå›¾
    #   åŒ…å«è´¦æˆ·ä½™é¢ã€ä»Šæ—¥æ¶ˆè€—ç­‰å…³é”®ä¿¡æ¯
    
    config:
      type: "viewport"
      quality: 85
      format: "png"
      
      # æˆªå›¾å‰çš„å‡†å¤‡ï¼š
      before_screenshot:
        # éšè—ä¸å¿…è¦çš„å…ƒç´ 
        hide_elements:
          - ".notification"
          - ".toast"
          - "[role='dialog']"  # å¼¹çª—
          - "[role='alert']"  # æç¤ºæ¡†
        
        # æ»šåŠ¨åˆ°ä½™é¢å¡ç‰‡ï¼ˆç¡®ä¿åœ¨è§†å£å†…ï¼‰
        scroll_to: "div.stat:has(div.stat-title:has-text('Account Balance'))"
        scroll_behavior: "smooth"
        
        # ç­‰å¾…åŠ¨ç”»å®Œæˆ
        wait_after_scroll: 500  # ç­‰å¾… 500ms
    
    storage:
      bucket: "monitor-screenshots"
      path_template: "{site_id}/{date}/{step_id}.{format}"
      overwrite: true  # æ¯å¤©åªä¿ç•™æœ€æ–°çš„æˆªå›¾
      access_level: "authenticated"
      
      # å…ƒæ•°æ®ï¼ˆä¿å­˜åˆ° Supabase Storage çš„ metadataï¼‰
      metadata:
        site: "TikHub"
        page: "Overview"
        purpose: "balance_monitoring"
    
    on_success:
      add_url_to_data: true
      url_field: "screenshot_url"
      
      # ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå¯é€‰ï¼‰
      generate_thumbnail: true
      thumbnail_size: [200, 150]
      thumbnail_field: "screenshot_thumbnail_url"
    
    on_failure:
      action: "log"
      critical: false  # ä¸æ˜¯å…³é”®æ­¥éª¤ï¼Œå¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹

###################################################################################
# Cookie éªŒè¯é…ç½®
###################################################################################
cookie_validation:
  # å·²ç™»å½•æ ‡å¿—ï¼š
  logged_in_indicators:
    - selector: "div.stat-title:has-text('Account Balance')"
      should_exist: true
      description: "Account Balance å¡ç‰‡å­˜åœ¨"
    
    - selector: "button:has-text('Check In')"
      should_exist: true
      description: "Check In æŒ‰é’®å­˜åœ¨ï¼ˆä»…ç™»å½•ç”¨æˆ·å¯è§ï¼‰"
    
    - selector: ".stat-value"
      should_exist: true
      description: "ç»Ÿè®¡æ•°å€¼å…ƒç´ å­˜åœ¨"
  
  # æœªç™»å½•æ ‡å¿—ï¼š
  logged_out_indicators:
    - selector: "text=/Sign In|Log In|Login/"
      should_exist: true
      description: "å‡ºç°ç™»å½•ç›¸å…³æ–‡æœ¬"
    
    - selector: "input[type='email'], input[type='password']"
      should_exist: true
      description: "å‡ºç°ç™»å½•è¡¨å•"
    
    - selector: "a[href*='/login']"
      should_exist: true
      description: "å‡ºç°ç™»å½•é“¾æ¥"
  
  # Cloudflare éªŒè¯æ ‡å¿—ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰ï¼š
  cloudflare_indicators:
    - selector: "text=/Checking your browser|Just a moment/"
      description: "Cloudflare éªŒè¯ä¸­"
      action: "wait_and_retry"
      wait_time: 10000  # ç­‰å¾… 10 ç§’åé‡è¯•
  
  timeout: 15000
  
  on_invalid:
    action: "abort"
    reason: "cookie_expired"
    message: "Cookie éªŒè¯å¤±è´¥ï¼Œè¯·æ›´æ–°è®¤è¯ä¿¡æ¯"
    notify: true
    notification_channels: ["email", "webhook"]

###################################################################################
# æ•°æ®å¤„ç†ä¸å­˜å‚¨é…ç½®
###################################################################################
data_processing:
  # æ•°æ®æ¸…æ´—ï¼š
  cleaning_rules:
    - field: "account_balance"
      remove_chars: ["$", ",", " "]
      round_to: 4  # ä¿ç•™ 4 ä½å°æ•°
    
    - field: "daily_cost"
      remove_chars: ["$", ",", " "]
      round_to: 4
  
  # æ•°æ®éªŒè¯ï¼š
  validation_rules:
    - field: "account_balance"
      rules:
        - type: "not_null"
          error: "è´¦æˆ·ä½™é¢ä¸èƒ½ä¸ºç©º"
        
        - type: "numeric"
          error: "è´¦æˆ·ä½™é¢å¿…é¡»æ˜¯æ•°å­—"
        
        - type: "range"
          min: 0.0
          max: 1000.0
          error: "è´¦æˆ·ä½™é¢è¶…å‡ºåˆç†èŒƒå›´"
    
    - field: "daily_cost"
      rules:
        - type: "numeric"
        - type: "range"
          min: 0.0
          max: 100.0
  
  # æ•°æ®å¢å¼ºï¼š
  enrichment:
    # æ ¼å¼åŒ–æ˜¾ç¤º
    - field: "account_balance_formatted"
      formula: "'$' + format(account_balance, '.4f')"
    
    - field: "daily_cost_formatted"
      formula: "'$' + format(daily_cost, '.4f')"
    
    # è®¡ç®—ä½™é¢çŠ¶æ€
    - field: "balance_status"
      formula: |
        if account_balance < 1.0:
          return "critical"
        elif account_balance < 5.0:
          return "warning"
        else:
          return "normal"
    
    # è®¡ç®—å¯ç”¨å¤©æ•°ï¼ˆåŸºäºä»Šæ—¥æ¶ˆè€—ï¼‰
    - field: "estimated_days_remaining"
      formula: |
        if daily_cost > 0:
          return int(account_balance / daily_cost)
        else:
          return None
      description: "æ ¹æ®ä»Šæ—¥æ¶ˆè€—ä¼°ç®—çš„å‰©ä½™å¯ç”¨å¤©æ•°"
    
    # æ·»åŠ é‡‡é›†å…ƒæ•°æ®
    - field: "metadata"
      value:
        source: "github_actions"
        version: "2.0"
        collector: "puppeteer"
        cloudflare_protected: true

storage_config:
  table: "keep_monitor_records"
  field_mapping:
    account_balance: "data->account_balance"
    account_balance_formatted: "data->account_balance_formatted"
    balance_status: "data->balance_status"
    daily_cost: "data->daily_cost"
    daily_cost_formatted: "data->daily_cost_formatted"
    estimated_monthly_cost: "data->estimated_monthly_cost"
    estimated_days_remaining: "data->estimated_days_remaining"
    metadata: "data->metadata"
    screenshot_url: "screenshot_url"
    balance_checked_at: "created_at"
  on_conflict: "replace"

###################################################################################
# é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥
###################################################################################
error_handling:
  global_retry:
    max_attempts: 3
    backoff_strategy: "exponential"
    initial_delay: 2000  # åˆå§‹å»¶è¿Ÿ 2 ç§’ï¼ˆè€ƒè™‘ Cloudflareï¼‰
    max_delay: 60000  # æœ€å¤§å»¶è¿Ÿ 60 ç§’
  
  specific_errors:
    # ç½‘ç»œè¶…æ—¶ï¼ˆå¯èƒ½æ˜¯ Cloudflare éªŒè¯ï¼‰
    - error_type: "TimeoutError"
      action: "retry"
      max_retries: 5
      message: "ç½‘ç»œè¶…æ—¶ï¼Œå¯èƒ½æ˜¯ Cloudflare éªŒè¯ï¼Œæ­£åœ¨é‡è¯•..."
    
    # Cookie å¤±æ•ˆ
    - error_type: "AuthenticationError"
      action: "abort"
      notify: true
      message: "è®¤è¯å¤±è´¥ï¼šCookie å·²å¤±æ•ˆ"
    
    # å…ƒç´ æœªæ‰¾åˆ°ï¼ˆå¯èƒ½æ˜¯é¡µé¢ç»“æ„å˜æ›´ï¼‰
    - error_type: "ElementNotFoundError"
      action: "retry"
      max_retries: 3
      message: "é¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œå¯èƒ½é‡åˆ° Cloudflare éªŒè¯æˆ–é¡µé¢ç»“æ„å˜æ›´"
    
    # Cloudflare Challenge
    - error_type: "CloudflareError"
      action: "abort"
      notify: true
      message: "é‡åˆ° Cloudflare äººæœºéªŒè¯ï¼Œéœ€è¦æ›´æ–°æµè§ˆå™¨ç‰¹å¾æˆ–æ‰‹åŠ¨è®¿é—®"
      include_screenshot: true
    
    # æ•°æ®æå–å¤±è´¥
    - error_type: "ExtractionError"
      action: "abort"
      notify: true
      message: "æ•°æ®æå–å¤±è´¥ï¼šé¡µé¢ç»“æ„å¯èƒ½å·²å˜æ›´"
      save_html: true
  
  logging:
    level: "info"
    include_screenshot: true
    include_html: true

###################################################################################
# ç›‘æ§ä¸å‘Šè­¦é…ç½®
###################################################################################
monitoring:
  collect_metrics: true
  metrics:
    - page_load_time
    - cloudflare_wait_time  # Cloudflare éªŒè¯ç­‰å¾…æ—¶é—´
    - total_execution_time
    - screenshot_time
    - extraction_time
  
  alerts:
    # ä½™é¢ä¸è¶³å‘Šè­¦
    - name: "low_balance_alert"
      condition: "account_balance < 5.0"
      severity: "warning"
      message: "âš ï¸ TikHub è´¦æˆ·ä½™é¢ä¸è¶³ï¼š$${account_balance}"
      channels: ["email", "webhook"]
    
    # ä½™é¢ä¸¥é‡ä¸è¶³å‘Šè­¦
    - name: "critical_balance_alert"
      condition: "account_balance < 1.0"
      severity: "critical"
      message: "ğŸš¨ TikHub è´¦æˆ·ä½™é¢ä¸¥é‡ä¸è¶³ï¼š$${account_balance}ï¼Œè¯·åŠæ—¶å……å€¼ï¼"
      channels: ["email", "webhook", "sms"]
    
    # ä»Šæ—¥æ¶ˆè€—è¿‡é«˜å‘Šè­¦
    - name: "high_daily_cost_alert"
      condition: "daily_cost > 2.0"
      severity: "warning"
      message: "âš ï¸ TikHub ä»Šæ—¥æ¶ˆè€—è¾ƒé«˜ï¼š$${daily_cost}"
      channels: ["webhook"]
    
    # é‡‡é›†å¤±è´¥å‘Šè­¦
    - name: "collection_failed_alert"
      condition: "status == 'failed'"
      severity: "error"
      message: "âŒ TikHub æ•°æ®é‡‡é›†å¤±è´¥ï¼š${error_message}"
      channels: ["email", "webhook"]
    
    # Cloudflare éªŒè¯å‘Šè­¦
    - name: "cloudflare_challenge_alert"
      condition: "error_type == 'CloudflareError'"
      severity: "warning"
      message: "âš ï¸ TikHub é‡åˆ° Cloudflare äººæœºéªŒè¯"
      channels: ["webhook"]

###################################################################################
# è°ƒè¯•é…ç½®
###################################################################################
debug:
  enabled: false
  options:
    verbose_logging: true
    save_html: true
    html_path: "./debug/tikhub_{timestamp}.html"
    save_full_screenshot: true
    screenshot_path: "./debug/tikhub_{timestamp}.png"
    pause_on_error: false
    pause_duration: 30000
    headless: false
    
    # Cloudflare è°ƒè¯•é€‰é¡¹
    cloudflare_debug:
      log_challenges: true  # è®°å½• Cloudflare éªŒè¯è¿‡ç¨‹
      save_challenge_screenshot: true  # ä¿å­˜éªŒè¯é¡µé¢æˆªå›¾
      retry_on_challenge: true  # é‡åˆ°éªŒè¯æ—¶è‡ªåŠ¨é‡è¯•

###################################################################################
# ç‰ˆæœ¬ä¿¡æ¯
###################################################################################
version: "2.0.0"
last_updated: "2025-11-11"
author: "AI Assistant"
changelog:
  - version: "2.0.0"
    date: "2025-11-11"
    changes:
      - "å®Œå…¨é‡æ„é…ç½®æ–‡ä»¶ï¼Œå¢åŠ è¯¦ç»†æ³¨é‡Š"
      - "åŸºäºå®é™…é¡µé¢ç»“æ„ä¼˜åŒ–é€‰æ‹©å™¨"
      - "æ·»åŠ  Cloudflare ä¿æŠ¤æ£€æµ‹å’Œå¤„ç†"
      - "åŒæ—¶æå–è´¦æˆ·ä½™é¢å’Œä»Šæ—¥æ¶ˆè€—"
      - "æ·»åŠ å‰©ä½™å¯ç”¨å¤©æ•°ä¼°ç®—"
      - "æ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œå‘Šè­¦æœºåˆ¶"
      - "æ·»åŠ  Cloudflare ç›¸å…³çš„è°ƒè¯•é€‰é¡¹"
  
  - version: "1.0.0"
    date: "2025-11-10"
    changes:
      - "åˆå§‹ç‰ˆæœ¬"

