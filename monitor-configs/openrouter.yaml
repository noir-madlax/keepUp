# OpenRouter 费用监控配置
# 网站: https://openrouter.ai/settings/credits
# 监控目标: Credits余额（美元）
# 最后更新: 2025-11-11

name: OpenRouter
url: https://openrouter.ai/settings/credits

# 抓取步骤配置
steps:
  # 步骤1: 导航到Credits页面
  - action: navigate
    url: "{{ url }}"
    wait_for: networkidle
    timeout: 30000
    comment: |
      访问Credits设置页面
      等待网络空闲状态，确保页面完全加载
      超时时间30秒，因为可能需要重定向认证

  # 步骤2: 等待Credits金额元素出现
  - action: wait
    selector: "text=/\\$\\s*[\\d.]+|Credits/"
    timeout: 10000
    comment: |
      等待页面中出现美元符号($)加数字 或 "Credits"文本
      这表示费用信息已经渲染完成
      最多等待10秒，超时则认为Cookie可能失效

  # 步骤3: 提取Credits余额
  - action: extract
    name: credits
    # 方法1: 通过文本正则匹配
    selector: "text=/\\$\\s*([\\d.]+)/"
    extract_type: regex
    regex_group: 1
    transform: float
    fallback_selector: ".credits-amount, [data-testid='credits-balance']"
    comment: |
      提取Credits余额数值
      正则表达式: \$ 后面跟着数字和小数点
      例如: "$ 7.73" 提取出 "7.73"
      然后转换为浮点数: 7.73
      如果正则匹配失败，尝试通过CSS选择器获取

  # 步骤4: 提取其他相关信息（可选）
  - action: extract
    name: usage_info
    selector: "text=/Usage included in your plan|Resets/"
    extract_type: text
    optional: true
    comment: |
      提取额外的使用信息
      例如: "Usage included in your plan. Resets Dec 4, 2025"
      这是可选字段，获取失败不影响主流程

  # 步骤5: 截图保存
  - action: screenshot
    full_page: false
    quality: 90
    comment: |
      截取当前可见区域的截图
      不截取整个页面（full_page=false）节省存储空间
      JPEG质量90%，平衡清晰度和文件大小
      截图会自动上传到 Supabase Storage

# Cookie有效性验证配置
validation:
  # 检查是否已登录
  cookie_check:
    selector: "button:has-text('Sign Out'), a:has-text('Sign Out')"
    should_exist: true
    comment: |
      检测页面是否存在"Sign Out"按钮或链接
      如果存在，说明用户已登录，Cookie有效
      如果不存在，可能跳转到登录页，Cookie失效
  
  # 检查是否在登录页（Cookie失效的标志）
  login_page_check:
    selector: "text=/Sign In|Log In|Email|Password/"
    should_exist: false
    comment: |
      检查是否出现登录表单相关元素
      如果出现，说明被重定向到登录页，Cookie失效

# 错误处理配置
error_handling:
  # 重试配置
  retry_on_failure: true
  max_retries: 2
  retry_delay: 5000  # 5秒
  
  # 超时处理
  page_load_timeout: 30000
  element_wait_timeout: 10000
  
  # 错误分类
  error_patterns:
    - pattern: "401|Unauthorized|Please sign in"
      category: cookie_invalid
      message: "Cookie已失效，需要重新登录"
    
    - pattern: "timeout|TIMEOUT"
      category: network_error
      message: "网络超时，请稍后重试"
    
    - pattern: "429|Too Many Requests"
      category: rate_limit
      message: "请求过于频繁，请稍后重试"

# 数据映射配置
data_mapping:
  # 定义输出数据结构
  output:
    credits:
      type: number
      unit: USD
      description: "可用Credits余额"
    
    usage_info:
      type: string
      optional: true
      description: "使用计划信息"
    
    scraped_at:
      type: datetime
      auto: true
      description: "数据抓取时间"

# 元数据
metadata:
  update_frequency: daily  # 每天更新一次
  critical_level: high     # 重要程度：高
  alert_threshold:
    credits_low: 1.0       # 余额低于$1时告警
  tags:
    - ai-api
    - payment
    - llm

