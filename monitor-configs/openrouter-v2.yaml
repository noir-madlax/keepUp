###################################################################################
# OpenRouter Credits ç›‘æ§é…ç½® (Version 2.0)
###################################################################################
# ä¸šåŠ¡è¯´æ˜ï¼š
#   æœ¬é…ç½®ç”¨äºç›‘æ§ OpenRouter.ai å¹³å°çš„ Credits ä½™é¢
#   Credits æ˜¯ OpenRouter å¹³å°çš„ç§¯åˆ†ç³»ç»Ÿï¼Œç”¨äºè°ƒç”¨å„ç§ AI æ¨¡å‹API
#   ç›‘æ§ç›®çš„ï¼šåŠæ—¶äº†è§£ä½™é¢å˜åŒ–ï¼Œé¿å…å› ä½™é¢ä¸è¶³å¯¼è‡´æœåŠ¡ä¸­æ–­
#
# é¡µé¢ç‰¹å¾ï¼š
#   - URL: https://openrouter.ai/settings/credits
#   - è®¤è¯è¦æ±‚ï¼šéœ€è¦ç™»å½•çŠ¶æ€ï¼ˆé€šè¿‡ Cookieï¼‰
#   - é¡µé¢æŠ€æœ¯æ ˆï¼šReact + TailwindCSS + å¤æ‚çš„æ•°å­—åŠ¨ç”»æ•ˆæœ
#   - æ•°æ®æ›´æ–°é¢‘ç‡ï¼šå®æ—¶
#   - å…³é”®æ•°æ®ï¼šCredits ä½™é¢ï¼ˆå¦‚ï¼š$7.733ï¼‰
###################################################################################

name: "OpenRouter"
site_id: "openrouter"
url: "https://openrouter.ai/settings/credits"
description: "ç›‘æ§ OpenRouter Credits ç§¯åˆ†ä½™é¢"
icon_url: "https://openrouter.ai/favicon.ico"

# ä¸šåŠ¡é‡è¦æ€§é…ç½®
priority: "high"  # high/medium/low - å†³å®šå‘Šè­¦ä¼˜å…ˆçº§
alert_threshold:  # å‘Šè­¦é˜ˆå€¼é…ç½®
  low_balance: 5.0  # å½“ä½™é¢ä½äºæ­¤å€¼æ—¶å‘é€å‘Šè­¦
  critical_balance: 1.0  # å½“ä½™é¢ä½äºæ­¤å€¼æ—¶å‘é€ç´§æ€¥å‘Šè­¦

###################################################################################
# æµè§ˆå™¨ç¯å¢ƒé…ç½®
###################################################################################
browser_config:
  # è§†å£å¤§å°ï¼šè®¾ç½®ä¸ºå¸¸è§çš„æ¡Œé¢åˆ†è¾¨ç‡ï¼Œç¡®ä¿é¡µé¢å®Œæ•´æ¸²æŸ“
  viewport:
    width: 1920
    height: 1080
  
  # User-Agentï¼šæ¨¡æ‹ŸçœŸå®çš„ macOS Chrome æµè§ˆå™¨
  # ä½œç”¨ï¼šé¿å…è¢«ç½‘ç«™è¯†åˆ«ä¸ºçˆ¬è™«è€Œæ‹’ç»è®¿é—®
  user_agent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
  
  # è¶…æ—¶é…ç½®ï¼ˆæ¯«ç§’ï¼‰
  timeouts:
    navigation: 30000  # é¡µé¢å¯¼èˆªè¶…æ—¶ï¼š30ç§’
    wait_for_selector: 15000  # ç­‰å¾…å…ƒç´ å‡ºç°è¶…æ—¶ï¼š15ç§’
    screenshot: 5000  # æˆªå›¾è¶…æ—¶ï¼š5ç§’

###################################################################################
# é¡µé¢è®¿é—®ä¸ç™»å½•éªŒè¯æ­¥éª¤
###################################################################################
steps:
  # ============================================================================
  # æ­¥éª¤ 1: å¯¼èˆªåˆ° Credits é¡µé¢
  # ============================================================================
  - step_id: "nav_to_credits"
    action: "navigate"
    url: "https://openrouter.ai/settings/credits"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   è®¿é—® OpenRouter çš„ Credits è®¾ç½®é¡µé¢
    #   è¿™æ˜¯æŸ¥çœ‹å’Œç®¡ç† API Credits çš„ä¸»è¦é¡µé¢
    
    # æŠ€æœ¯ç»†èŠ‚ï¼š
    #   - wait_until: 'networkidle' ç¡®ä¿æ‰€æœ‰ç½‘ç»œè¯·æ±‚å®Œæˆ
    #   - åŒ…æ‹¬ä¸»é¡µé¢ã€CSSã€JSã€å­—ä½“ã€å›¾ç‰‡ç­‰èµ„æº
    #   - networkidle å®šä¹‰ï¼šè‡³å°‘ 500ms å†…æ²¡æœ‰è¶…è¿‡ 2 ä¸ªç½‘ç»œè¿æ¥
    
    config:
      wait_until: "networkidle"  # ç­‰å¾…ç½‘ç»œç©ºé—²ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
      timeout: 30000
    
    # æœŸæœ›ç»“æœï¼š
    #   - HTTP çŠ¶æ€ç ï¼š200
    #   - é¡µé¢æ ‡é¢˜åŒ…å« "OpenRouter" æˆ– "Credits"
    #   - URL åŒ…å« "/settings/credits"
    
    validation:
      - type: "url_contains"
        value: "/settings/credits"
        error_message: "é¡µé¢å¯¼èˆªå¤±è´¥ï¼šæœªèƒ½è·³è½¬åˆ° Credits é¡µé¢"
      
      - type: "http_status"
        value: 200
        error_message: "HTTP è¯·æ±‚å¤±è´¥ï¼šçŠ¶æ€ç é 200"

  # ============================================================================
  # æ­¥éª¤ 2: éªŒè¯ç™»å½•çŠ¶æ€
  # ============================================================================
  - step_id: "verify_login"
    action: "wait_for_element"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   éªŒè¯ç”¨æˆ·æ˜¯å¦å·²æˆåŠŸç™»å½•
    #   æœªç™»å½•ç”¨æˆ·ä¼šçœ‹åˆ°ç™»å½•æŒ‰é’®ï¼Œå·²ç™»å½•ç”¨æˆ·ä¼šçœ‹åˆ°è´¦æˆ·ä¿¡æ¯
    
    # æ ¸å¿ƒæŠ€æœ¯ç‚¹ï¼š
    #   é€šè¿‡æ£€æµ‹ç‰¹å®šå…ƒç´ çš„å­˜åœ¨æ¥åˆ¤æ–­ç™»å½•çŠ¶æ€
    #   OpenRouter çš„å·²ç™»å½•æ ‡å¿—ï¼š
    #   - aria-label å±æ€§åŒ…å« "Remaining credits"
    #   - æˆ–è€…å­˜åœ¨ç”¨æˆ·å¤´åƒå…ƒç´ 
    
    selectors:
      # ä¸»é€‰æ‹©å™¨ï¼šCredits ä½™é¢å¡ç‰‡
      # è¿™ä¸ªå…ƒç´ åªæœ‰åœ¨ç™»å½•çŠ¶æ€ä¸‹æ‰ä¼šå‡ºç°
      primary: "[aria-label*='Remaining credits']"
      
      # å¤‡ç”¨é€‰æ‹©å™¨ï¼šç”¨æˆ·å¤´åƒæŒ‰é’®
      # ä½ç½®ï¼šé¡µé¢å³ä¸Šè§’
      # ç‰¹å¾ï¼šåŒ…å«ç”¨æˆ·ç¼©å†™å­—æ¯çš„åœ†å½¢å¤´åƒ
      fallback: 
        - "button[aria-label*='account']"
        - ".user-avatar"
        - "[data-testid='user-menu']"
    
    config:
      timeout: 15000
      # visible: true è¡¨ç¤ºå…ƒç´ å¿…é¡»å¯è§ï¼ˆä¸èƒ½æ˜¯ display:none æˆ– visibility:hiddenï¼‰
      visible: true
    
    # å¤±è´¥å¤„ç†ï¼š
    #   å¦‚æœç™»å½•éªŒè¯å¤±è´¥ï¼Œè¯´æ˜ Cookie å¯èƒ½å·²è¿‡æœŸ
    #   éœ€è¦æ›´æ–° Cookie æˆ–é‡æ–°ç™»å½•
    on_failure:
      action: "abort"  # ç»ˆæ­¢åç»­æ­¥éª¤
      reason: "cookie_expired"
      message: "ç™»å½•çŠ¶æ€éªŒè¯å¤±è´¥ï¼šCookie å¯èƒ½å·²è¿‡æœŸï¼Œè¯·æ›´æ–°è®¤è¯ä¿¡æ¯"

  # ============================================================================
  # æ­¥éª¤ 3: ç­‰å¾… Credits æ•°æ®åŠ è½½
  # ============================================================================
  - step_id: "wait_for_credits_data"
    action: "wait_for_element"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   OpenRouter çš„ Credits ä½™é¢ä½¿ç”¨åŠ¨ç”»æ•°å­—æ»šåŠ¨æ•ˆæœæ˜¾ç¤º
    #   æ•°å­—é€šè¿‡ CSS transform åŠ¨ç”»ä»ä¸Šå¾€ä¸‹æ»šåŠ¨åˆ°æœ€ç»ˆå€¼
    #   éœ€è¦ç­‰å¾…åŠ¨ç”»å®Œæˆåæ‰èƒ½å‡†ç¡®è¯»å–æ•°å€¼
    
    # é¡µé¢ç»“æ„åˆ†æï¼ˆåŸºäºå®é™… HTMLï¼‰ï¼š
    #   <div aria-label="Remaining credits: 7.733">  â† åŒ…å«å®Œæ•´æ•°å€¼
    #     <div class="flex items-center gap-2">
    #       <span class="text-4xl">$</span>
    #       <span class="text-4xl">                    â† åŠ¨ç”»æ•°å­—å®¹å™¨
    #         <span class="relative">                 â† æ•°å­—æ»šåŠ¨å®¹å™¨
    #           <div class="relative">                â† ä¸ªä½æ•°
    #             <div style="transform: translateY(280px)">  â† æ»šåŠ¨åˆ° 7
    #               <div>9</div>
    #               <div>8</div>
    #               <div>7</div>  â† æœ€ç»ˆæ˜¾ç¤ºçš„æ•°å­—
    #               ...
    #             </div>
    #           </div>
    #           <div>.</div>                         â† å°æ•°ç‚¹
    #           <div class="relative">                â† å°æ•°ä½
    #             ...
    #           </div>
    #         </span>
    #       </span>
    #     </div>
    #   </div>
    
    # ç­‰å¾…ç­–ç•¥ï¼š
    #   æ–¹æ¡ˆ 1ï¼šç­‰å¾… aria-label å±æ€§å‡ºç°ï¼ˆæ¨èï¼‰
    #     ä¼˜ç‚¹ï¼šaria-label ç›´æ¥åŒ…å«å®Œæ•´æ•°å€¼ï¼Œä¸å—åŠ¨ç”»å½±å“
    #     ç¼ºç‚¹ï¼šä¾èµ– OpenRouter ä¿æŒæ­¤å±æ€§
    #
    #   æ–¹æ¡ˆ 2ï¼šç­‰å¾…åŠ¨ç”»å®Œæˆ
    #     ä¼˜ç‚¹ï¼šä¸ä¾èµ–ç‰¹å®šå±æ€§
    #     ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–ç­‰å¾…åŠ¨ç”»æ—¶é—´ï¼ˆçº¦ 1-2 ç§’ï¼‰
    
    selectors:
      # ä¸»é€‰æ‹©å™¨ï¼šåŒ…å«å®Œæ•´ Credits æ•°å€¼çš„ aria-label
      primary: "[aria-label*='Remaining credits']"
      
      # å¤‡ç”¨é€‰æ‹©å™¨ï¼šCredits å¡ç‰‡å®¹å™¨
      fallback:
        - ".group\\/card[aria-label]"  # å¡ç‰‡å®¹å™¨
        - "div[tabindex='0'][aria-label*='credits']"
    
    config:
      timeout: 15000
      visible: true
      
      # é¢å¤–ç­‰å¾…åŠ¨ç”»å®Œæˆæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      # OpenRouter çš„æ•°å­—æ»šåŠ¨åŠ¨ç”»çº¦ 1 ç§’
      additional_wait: 1500
    
    # æœŸæœ›ç»“æœï¼š
    #   - aria-label å±æ€§å­˜åœ¨
    #   - aria-label åŒ…å«æ•°å­—æ ¼å¼ï¼ˆå¦‚ "Remaining credits: 7.733"ï¼‰
    #   - æ•°å­—åŠ¨ç”»å·²å®Œæˆ
    
    validation:
      - type: "attribute_exists"
        attribute: "aria-label"
        error_message: "Credits æ•°æ®å…ƒç´ ç¼ºå°‘ aria-label å±æ€§"
      
      - type: "attribute_matches"
        attribute: "aria-label"
        pattern: "Remaining credits: \\d+(\\.\\d+)?"
        error_message: "Credits æ•°å€¼æ ¼å¼ä¸æ­£ç¡®"

  # ============================================================================
  # æ­¥éª¤ 4: æå– Credits ä½™é¢æ•°æ®
  # ============================================================================
  - step_id: "extract_credits_balance"
    action: "extract"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   æå–å½“å‰ Credits ä½™é¢æ•°å€¼
    #   è¿™æ˜¯æœ¬æ¬¡ç›‘æ§çš„æ ¸å¿ƒæ•°æ®
    
    # æå–ç­–ç•¥ï¼š
    #   ä¼˜å…ˆä» aria-label æå–ï¼ˆæœ€å¯é ï¼‰
    #   å¤‡ç”¨æ–¹æ¡ˆï¼šä»é¡µé¢æ–‡æœ¬å†…å®¹æå–
    
    target:
      field_name: "credits_balance"  # å­—æ®µåç§°ï¼Œå­˜å…¥æ•°æ®åº“
      field_type: "currency"  # æ•°æ®ç±»å‹ï¼šè´§å¸é‡‘é¢
      field_description: "OpenRouter Credits ä½™é¢"
    
    extraction:
      # æå–æ–¹æ³• 1ï¼šä» aria-label å±æ€§æå–ï¼ˆæ¨èï¼‰
      - method: "attribute"
        selector: "[aria-label*='Remaining credits']"
        attribute: "aria-label"
        
        # æ­£åˆ™è¡¨è¾¾å¼è¯´æ˜ï¼š
        #   Remaining credits: (\d+(?:\.\d+)?)
        #   - Remaining credits:  â†’ å›ºå®šå‰ç¼€
        #   - \d+               â†’ æ•´æ•°éƒ¨åˆ†ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªæ•°å­—ï¼‰
        #   - (?:\.\d+)?        â†’ å°æ•°éƒ¨åˆ†ï¼ˆå¯é€‰ï¼‰
        #     \.               â†’ å°æ•°ç‚¹
        #     \d+              â†’ å°æ•°æ•°å­—
        #     (?:...)          â†’ éæ•è·ç»„
        #     ?                â†’ å¯é€‰ï¼ˆ0 æ¬¡æˆ– 1 æ¬¡ï¼‰
        #   - ()                â†’ æ•è·ç»„ï¼ˆæå–çš„å†…å®¹ï¼‰
        
        regex: "Remaining credits:\\s*\\$?(\\d+(?:\\.\\d+)?)"
        regex_group: 1  # æå–ç¬¬ä¸€ä¸ªæ•è·ç»„çš„å†…å®¹
        
        # æ•°æ®è½¬æ¢ï¼š
        #   å°†å­—ç¬¦ä¸² "7.733" è½¬æ¢ä¸ºæµ®ç‚¹æ•° 7.733
        transform: "float"
        
        # æ•°æ®éªŒè¯ï¼š
        validation:
          min_value: 0.0  # æœ€å°å€¼ï¼š0
          max_value: 10000.0  # æœ€å¤§å€¼ï¼š10000ï¼ˆåˆç†èŒƒå›´ï¼‰
          decimal_places: 4  # å°æ•°ä½æ•°ï¼šæœ€å¤š 4 ä½
      
      # æå–æ–¹æ³• 2ï¼šä»æ–‡æœ¬å†…å®¹æå–ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
      - method: "text"
        selector: ".text-4xl.font-bold"
        
        # å¤‡ç”¨æ­£åˆ™ï¼šç›´æ¥åŒ¹é…ç¾å…ƒç¬¦å·å’Œæ•°å­—
        regex: "\\$?(\\d+(?:\\.\\d+)?)"
        regex_group: 1
        transform: "float"
        
        # æ³¨æ„äº‹é¡¹ï¼š
        #   æ­¤æ–¹æ³•å¯èƒ½å—åŠ¨ç”»å½±å“
        #   å¦‚æœæ•°å­—è¿˜åœ¨æ»šåŠ¨ï¼Œå¯èƒ½è¯»å–åˆ°é”™è¯¯çš„å€¼
        #   å› æ­¤è®¾ç½®ä¸ºå¤‡ç”¨æ–¹æ¡ˆ
    
    # æå–æˆåŠŸåçš„å¤„ç†ï¼š
    on_success:
      # è®°å½•æå–æ—¶é—´
      add_timestamp: true
      timestamp_field: "extracted_at"
      
      # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
      check_threshold: true
      
      # å¦‚æœéœ€è¦ï¼Œå¯ä»¥ç«‹å³å‘é€é€šçŸ¥
      # send_notification: true
    
    # æå–å¤±è´¥åçš„å¤„ç†ï¼š
    on_failure:
      action: "retry"  # é‡è¯•
      max_retries: 3  # æœ€å¤šé‡è¯• 3 æ¬¡
      retry_delay: 2000  # é‡è¯•é—´éš”ï¼š2 ç§’
      
      # é‡è¯•å¤±è´¥åçš„æ“ä½œ
      final_action: "log"  # è®°å½•é”™è¯¯æ—¥å¿—
      error_field: "extraction_error"

  # ============================================================================
  # æ­¥éª¤ 5: æå–é¡µé¢æ›´æ–°æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  # ============================================================================
  - step_id: "extract_update_time"
    action: "extract"
    optional: true  # å¯é€‰æ­¥éª¤ï¼Œå¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   æå–é¡µé¢æ•°æ®çš„æ›´æ–°æ—¶é—´
    #   ç”¨äºåˆ¤æ–­æ•°æ®çš„æ—¶æ•ˆæ€§
    
    target:
      field_name: "last_updated"
      field_type: "datetime"
      field_description: "Credits ä½™é¢æœ€åæ›´æ–°æ—¶é—´"
    
    extraction:
      - method: "text"
        # å°è¯•æŸ¥æ‰¾æ—¶é—´ç›¸å…³çš„å…ƒç´ 
        selector: "time[datetime], [data-time], .timestamp, .last-updated"
        attribute: "datetime"  # ä¼˜å…ˆè¯»å– datetime å±æ€§
        
        # å¦‚æœæ²¡æœ‰ datetime å±æ€§ï¼Œåˆ™è¯»å–æ–‡æœ¬å†…å®¹
        fallback: "innerText"
        
        # æ—¶é—´æ ¼å¼è½¬æ¢
        transform: "datetime"
        
        # å¦‚æœæå–å¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
        default: "now"

  # ============================================================================
  # æ­¥éª¤ 6: æˆªå–é¡µé¢æˆªå›¾
  # ============================================================================
  - step_id: "capture_screenshot"
    action: "screenshot"
    
    # ä¸šåŠ¡è¯´æ˜ï¼š
    #   ä¿å­˜ Credits é¡µé¢çš„å®Œæ•´æˆªå›¾
    #   ç”¨é€”ï¼š
    #   1. å¯è§†åŒ–å†å²è®°å½•
    #   2. å¼‚å¸¸æƒ…å†µæ’æŸ¥
    #   3. æ•°æ®éªŒè¯ï¼ˆäººå·¥æ ¸å¯¹ï¼‰
    
    config:
      # æˆªå›¾ç±»å‹ï¼š
      #   full_page: false â†’ åªæˆªå–å¯è§†åŒºåŸŸ
      #   full_page: true  â†’ æˆªå–æ•´ä¸ªé¡µé¢ï¼ˆåŒ…æ‹¬æ»šåŠ¨åŒºåŸŸï¼‰
      type: "viewport"  # viewport/full_page/element
      
      # æˆªå›¾è´¨é‡ï¼š
      #   0-100ï¼Œæ•°å€¼è¶Šé«˜è´¨é‡è¶Šå¥½ï¼Œæ–‡ä»¶è¶Šå¤§
      #   å»ºè®®ï¼š80-90 å¯ä»¥å¹³è¡¡è´¨é‡å’Œæ–‡ä»¶å¤§å°
      quality: 85
      
      # å›¾ç‰‡æ ¼å¼ï¼špng/jpeg/webp
      #   png: æ— æŸå‹ç¼©ï¼Œæ–‡ä»¶è¾ƒå¤§ï¼Œæ”¯æŒé€æ˜
      #   jpeg: æœ‰æŸå‹ç¼©ï¼Œæ–‡ä»¶è¾ƒå°ï¼Œä¸æ”¯æŒé€æ˜
      #   webp: ç°ä»£æ ¼å¼ï¼Œæ–‡ä»¶å°è´¨é‡é«˜ï¼ˆæ¨èï¼‰
      format: "png"
      
      # æˆªå›¾åŒºåŸŸï¼ˆå¯é€‰ï¼‰ï¼š
      #   å¦‚æœæŒ‡å®šäº† clipï¼Œåˆ™åªæˆªå–æŒ‡å®šåŒºåŸŸ
      #   ä¸æŒ‡å®šåˆ™æˆªå–æ•´ä¸ªè§†å£
      # clip:
      #   selector: "[aria-label*='Remaining credits']"
      #   padding: 20  # åœ¨å…ƒç´ å‘¨å›´å¢åŠ  20px çš„è¾¹è·
      
      # æˆªå›¾å‰çš„é¢å¤–æ“ä½œï¼ˆå¯é€‰ï¼‰ï¼š
      before_screenshot:
        # éšè—ä¸å¿…è¦çš„å…ƒç´ ï¼ˆå¦‚æµ®åŠ¨æŒ‰é’®ã€é€šçŸ¥ï¼‰
        hide_elements:
          - ".notification"
          - ".floating-action-button"
          - "[role='dialog']"  # å¼¹çª—
        
        # æ»šåŠ¨åˆ°ç‰¹å®šå…ƒç´ ï¼ˆç¡®ä¿å…ƒç´ åœ¨è§†å£å†…ï¼‰
        scroll_to: "[aria-label*='Remaining credits']"
        scroll_behavior: "smooth"  # smooth/auto
    
    # æˆªå›¾ä¿å­˜é…ç½®ï¼š
    storage:
      # å­˜å‚¨ä½ç½®ï¼šSupabase Storage
      bucket: "monitor-screenshots"
      
      # æ–‡ä»¶è·¯å¾„ï¼š
      #   {site_id}/{date}/{timestamp}.png
      #   ç¤ºä¾‹ï¼šopenrouter/2025-11-11/20251111_090000.png
      path_template: "{site_id}/{date}/{step_id}.{format}"
      
      # æ˜¯å¦è¦†ç›–åŒåæ–‡ä»¶ï¼š
      #   true:  æ¯å¤©åªä¿ç•™ä¸€å¼ æˆªå›¾ï¼ˆèŠ‚çœç©ºé—´ï¼‰
      #   false: ä¿ç•™æ‰€æœ‰å†å²æˆªå›¾
      overwrite: true
      
      # æ–‡ä»¶æƒé™ï¼š
      #   public: å…¬å¼€è®¿é—®ï¼ˆä¸æ¨èï¼‰
      #   private: ç§æœ‰è®¿é—®ï¼ˆéœ€è¦è®¤è¯ï¼‰
      #   authenticated: éœ€è¦ Supabase è®¤è¯
      access_level: "authenticated"
    
    # æˆªå›¾æˆåŠŸåçš„å¤„ç†ï¼š
    on_success:
      # å°†æˆªå›¾ URL æ·»åŠ åˆ°æå–çš„æ•°æ®ä¸­
      add_url_to_data: true
      url_field: "screenshot_url"
      
      # å¯é€‰ï¼šç”Ÿæˆç¼©ç•¥å›¾
      # generate_thumbnail: true
      # thumbnail_size: [200, 150]  # width x height
    
    # æˆªå›¾å¤±è´¥åçš„å¤„ç†ï¼š
    on_failure:
      action: "log"  # è®°å½•é”™è¯¯ï¼Œä½†ä¸å½±å“æ•´ä½“æµç¨‹
      critical: false  # ä¸æ˜¯å…³é”®æ­¥éª¤

###################################################################################
# Cookie éªŒè¯é…ç½®
###################################################################################
# è¯´æ˜ï¼š
#   ç”¨äºéªŒè¯ Cookie æ˜¯å¦æœ‰æ•ˆ
#   æ— æ•ˆçš„ Cookie ä¼šå¯¼è‡´æœªç™»å½•çŠ¶æ€ï¼Œæ— æ³•è·å–æ•°æ®
###################################################################################
cookie_validation:
  # éªŒè¯æ–¹æ³•ï¼šæ£€æŸ¥ç‰¹å®šå…ƒç´ æ˜¯å¦å­˜åœ¨
  #   å¦‚æœæœªç™»å½•ï¼Œé¡µé¢ä¼šæ˜¾ç¤º "Sign In" æŒ‰é’®
  #   å¦‚æœå·²ç™»å½•ï¼Œé¡µé¢ä¼šæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œ Credits ä½™é¢
  
  # å·²ç™»å½•æ ‡å¿—ï¼ˆè‡³å°‘æ»¡è¶³ä¸€ä¸ªï¼‰ï¼š
  logged_in_indicators:
    - selector: "[aria-label*='Remaining credits']"
      should_exist: true
      description: "Credits ä½™é¢å¡ç‰‡å­˜åœ¨"
    
    - selector: "button:has-text('Sign In')"
      should_exist: false
      description: "ç™»å½•æŒ‰é’®ä¸å­˜åœ¨"
    
    - selector: "[data-testid='user-menu'], .user-avatar"
      should_exist: true
      description: "ç”¨æˆ·èœå•å­˜åœ¨"
  
  # æœªç™»å½•æ ‡å¿—ï¼ˆå¦‚æœå‡ºç°åˆ™è¡¨ç¤º Cookie å¤±æ•ˆï¼‰ï¼š
  logged_out_indicators:
    - selector: "button:has-text('Sign In')"
      should_exist: true
      description: "å‡ºç°ç™»å½•æŒ‰é’®"
    
    - selector: "a[href*='/login']"
      should_exist: true
      description: "å‡ºç°ç™»å½•é“¾æ¥"
  
  # éªŒè¯è¶…æ—¶æ—¶é—´ï¼š
  timeout: 10000
  
  # éªŒè¯å¤±è´¥åçš„å¤„ç†ï¼š
  on_invalid:
    action: "abort"
    reason: "cookie_expired"
    message: "Cookie éªŒè¯å¤±è´¥ï¼Œè¯·æ›´æ–°è®¤è¯ä¿¡æ¯"
    
    # æ˜¯å¦å‘é€é€šçŸ¥ï¼š
    notify: true
    notification_channels: ["email", "webhook"]

###################################################################################
# æ•°æ®å¤„ç†ä¸å­˜å‚¨é…ç½®
###################################################################################
data_processing:
  # æ•°æ®æ¸…æ´—è§„åˆ™ï¼š
  cleaning_rules:
    # ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ç¾å…ƒç¬¦å·ã€é€—å·ï¼‰
    - field: "credits_balance"
      remove_chars: ["$", ",", " "]
    
    # å››èˆäº”å…¥åˆ°æŒ‡å®šå°æ•°ä½
    - field: "credits_balance"
      round_to: 4
  
  # æ•°æ®éªŒè¯è§„åˆ™ï¼š
  validation_rules:
    - field: "credits_balance"
      rules:
        - type: "not_null"
          error: "Credits ä½™é¢ä¸èƒ½ä¸ºç©º"
        
        - type: "numeric"
          error: "Credits ä½™é¢å¿…é¡»æ˜¯æ•°å­—"
        
        - type: "range"
          min: 0
          max: 10000
          error: "Credits ä½™é¢è¶…å‡ºåˆç†èŒƒå›´"
  
  # æ•°æ®å¢å¼ºï¼šæ·»åŠ é¢å¤–çš„è®¡ç®—å­—æ®µ
  enrichment:
    # æ·»åŠ è´§å¸ç¬¦å·
    - field: "credits_balance_formatted"
      formula: "'$' + credits_balance"
    
    # è®¡ç®—è·ç¦»å‘Šè­¦é˜ˆå€¼çš„å·®å€¼
    - field: "balance_status"
      formula: |
        if credits_balance < 1.0:
          return "critical"
        elif credits_balance < 5.0:
          return "warning"
        else:
          return "normal"
    
    # æ·»åŠ é‡‡é›†å…ƒæ•°æ®
    - field: "metadata"
      value:
        source: "github_actions"
        version: "2.0"
        collector: "puppeteer"

# æ•°æ®å­˜å‚¨åˆ° Supabase
storage_config:
  table: "keep_monitor_records"
  
  # å­—æ®µæ˜ å°„ï¼š
  #   YAML ä¸­çš„å­—æ®µå â†’ æ•°æ®åº“åˆ—å
  field_mapping:
    credits_balance: "data->credits_balance"
    credits_balance_formatted: "data->credits_balance_formatted"
    balance_status: "data->balance_status"
    last_updated: "data->last_updated"
    screenshot_url: "screenshot_url"
    extracted_at: "created_at"
  
  # å†²çªå¤„ç†ï¼š
  #   å¦‚æœè®°å½•å·²å­˜åœ¨ï¼ˆåŸºäº site_slug + dateï¼‰
  #   replace: æ›¿æ¢æ—§è®°å½•
  #   ignore: å¿½ç•¥æ–°è®°å½•
  #   update: æ›´æ–°éƒ¨åˆ†å­—æ®µ
  on_conflict: "replace"

###################################################################################
# é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥
###################################################################################
error_handling:
  # å…¨å±€é‡è¯•é…ç½®ï¼š
  global_retry:
    max_attempts: 3  # æœ€å¤šé‡è¯• 3 æ¬¡
    backoff_strategy: "exponential"  # æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s, 8s...
    initial_delay: 1000  # åˆå§‹å»¶è¿Ÿï¼š1 ç§’
    max_delay: 30000  # æœ€å¤§å»¶è¿Ÿï¼š30 ç§’
  
  # ç‰¹å®šé”™è¯¯çš„å¤„ç†ï¼š
  specific_errors:
    # ç½‘ç»œè¶…æ—¶
    - error_type: "TimeoutError"
      action: "retry"
      max_retries: 5
      message: "ç½‘ç»œè¶…æ—¶ï¼Œæ­£åœ¨é‡è¯•..."
    
    # Cookie å¤±æ•ˆ
    - error_type: "AuthenticationError"
      action: "abort"
      notify: true
      message: "è®¤è¯å¤±è´¥ï¼šCookie å·²å¤±æ•ˆ"
    
    # å…ƒç´ æœªæ‰¾åˆ°
    - error_type: "ElementNotFoundError"
      action: "retry"
      max_retries: 3
      message: "é¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œå¯èƒ½é¡µé¢ç»“æ„å·²å˜æ›´"
    
    # é¡µé¢ç»“æ„å˜æ›´
    - error_type: "ExtractionError"
      action: "abort"
      notify: true
      message: "æ•°æ®æå–å¤±è´¥ï¼šé¡µé¢ç»“æ„å¯èƒ½å·²å˜æ›´ï¼Œéœ€è¦æ›´æ–°é…ç½®"
  
  # é”™è¯¯æ—¥å¿—è®°å½•ï¼š
  logging:
    level: "info"  # debug/info/warning/error
    include_screenshot: true  # å‘ç”Ÿé”™è¯¯æ—¶è‡ªåŠ¨æˆªå›¾
    include_html: true  # ä¿å­˜é¡µé¢ HTMLï¼ˆç”¨äºè°ƒè¯•ï¼‰

###################################################################################
# ç›‘æ§ä¸å‘Šè­¦é…ç½®
###################################################################################
monitoring:
  # æ€§èƒ½æŒ‡æ ‡æ”¶é›†ï¼š
  collect_metrics: true
  metrics:
    - page_load_time  # é¡µé¢åŠ è½½æ—¶é—´
    - total_execution_time  # æ€»æ‰§è¡Œæ—¶é—´
    - screenshot_time  # æˆªå›¾è€—æ—¶
    - extraction_time  # æ•°æ®æå–è€—æ—¶
  
  # å‘Šè­¦è§„åˆ™ï¼š
  alerts:
    # ä½™é¢ä¸è¶³å‘Šè­¦
    - name: "low_balance_alert"
      condition: "credits_balance < 5.0"
      severity: "warning"
      message: "âš ï¸ OpenRouter Credits ä½™é¢ä¸è¶³ï¼š${credits_balance}"
      channels: ["email", "webhook"]
    
    # ä½™é¢ä¸¥é‡ä¸è¶³å‘Šè­¦
    - name: "critical_balance_alert"
      condition: "credits_balance < 1.0"
      severity: "critical"
      message: "ğŸš¨ OpenRouter Credits ä½™é¢ä¸¥é‡ä¸è¶³ï¼š${credits_balance}"
      channels: ["email", "webhook", "sms"]
    
    # é‡‡é›†å¤±è´¥å‘Šè­¦
    - name: "collection_failed_alert"
      condition: "status == 'failed'"
      severity: "error"
      message: "âŒ OpenRouter æ•°æ®é‡‡é›†å¤±è´¥ï¼š${error_message}"
      channels: ["email", "webhook"]
    
    # æ€§èƒ½å‘Šè­¦
    - name: "slow_execution_alert"
      condition: "total_execution_time > 60000"  # è¶…è¿‡ 60 ç§’
      severity: "warning"
      message: "â±ï¸ OpenRouter æ•°æ®é‡‡é›†è€—æ—¶è¿‡é•¿ï¼š${total_execution_time}ms"
      channels: ["webhook"]

###################################################################################
# è°ƒè¯•ä¸å¼€å‘é…ç½®
###################################################################################
debug:
  # æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š
  enabled: false  # ç”Ÿäº§ç¯å¢ƒè®¾ç½®ä¸º false
  
  # è°ƒè¯•é€‰é¡¹ï¼š
  options:
    # ä¿å­˜è¯¦ç»†æ—¥å¿—
    verbose_logging: true
    
    # ä¿å­˜é¡µé¢ HTML
    save_html: true
    html_path: "./debug/openrouter_{timestamp}.html"
    
    # ä¿å­˜å®Œæ•´æˆªå›¾ï¼ˆåŒ…æ‹¬æ»šåŠ¨åŒºåŸŸï¼‰
    save_full_screenshot: true
    screenshot_path: "./debug/openrouter_{timestamp}.png"
    
    # æš‚åœæ‰§è¡Œï¼ˆç”¨äºæ‰‹åŠ¨æ£€æŸ¥ï¼‰
    pause_on_error: false
    pause_duration: 30000  # æš‚åœ 30 ç§’
    
    # æµè§ˆå™¨å¯è§æ¨¡å¼ï¼ˆéæ— å¤´ï¼‰
    headless: false  # true: æ— å¤´æ¨¡å¼ï¼Œfalse: å¯è§æ¨¡å¼

###################################################################################
# ç‰ˆæœ¬ä¿¡æ¯
###################################################################################
version: "2.0.0"
last_updated: "2025-11-11"
author: "AI Assistant"
changelog:
  - version: "2.0.0"
    date: "2025-11-11"
    changes:
      - "å®Œå…¨é‡æ„é…ç½®æ–‡ä»¶ï¼Œå¢åŠ è¯¦ç»†æ³¨é‡Š"
      - "åŸºäºå®é™…é¡µé¢ç»“æ„ä¼˜åŒ–é€‰æ‹©å™¨"
      - "æ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶"
      - "æ·»åŠ æ•°æ®éªŒè¯å’Œæ¸…æ´—è§„åˆ™"
      - "æ·»åŠ ç›‘æ§å‘Šè­¦åŠŸèƒ½"
      - "æ·»åŠ è°ƒè¯•æ”¯æŒ"
  
  - version: "1.0.0"
    date: "2025-11-10"
    changes:
      - "åˆå§‹ç‰ˆæœ¬"

