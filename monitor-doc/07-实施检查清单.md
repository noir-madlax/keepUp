# 实施检查清单

## ✅ 已完成项

### 阶段一：设计和准备 (100%)

- [x] 技术架构设计文档
- [x] 数据库表设计
- [x] 3个网站的YAML配置文件
- [x] 测试用例编写
- [x] 核心代码设计
- [x] 玻璃态UI设计方案

### 阶段二：数据库初始化 (100%)

- [x] 创建keep_monitor_sites表
- [x] 创建keep_monitor_cookies表
- [x] 创建keep_monitor_records表
- [x] 创建索引和外键约束
- [x] 导入OpenRouter配置和Cookie
- [x] 导入TikHub配置和Cookie
- [x] 导入Cursor配置和Cookie

**验证命令**:
```sql
-- 确认表已创建
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name LIKE 'keep_monitor_%';

-- 确认数据已导入
SELECT slug, name, is_active FROM keep_monitor_sites;
SELECT site_slug, is_valid, jsonb_array_length(cookies) as cookie_count 
FROM keep_monitor_cookies;
```

## 📋 待完成项

### 阶段三：Supabase Storage配置 (待完成)

- [ ] **Step 1**: 访问Supabase Dashboard
  - URL: https://supabase.com/dashboard/project/ojbocxqvufoblihkzijn/storage/buckets
  - 点击"New Bucket"

- [ ] **Step 2**: 创建Bucket
  - 名称: `monitor-screenshots`
  - Public: ✅ (勾选)
  - 点击Create

- [ ] **Step 3**: 配置RLS策略
  ```sql
  CREATE POLICY "Public Access"
  ON storage.objects FOR SELECT
  USING (bucket_id = 'monitor-screenshots');
  ```

- [ ] **Step 4**: 验证Bucket
  - 在Storage页面应该看到monitor-screenshots bucket
  - 尝试上传测试图片验证权限

**预期结果**: 可以通过URL访问上传的文件
```
https://ojbocxqvufoblihkzijn.supabase.co/storage/v1/object/public/monitor-screenshots/test.png
```

---

### 阶段四：Edge Functions开发 (待完成)

- [ ] **Step 1**: 创建Edge Functions目录结构
  ```bash
  mkdir -p supabase/functions/scrape-site
  mkdir -p supabase/functions/scrape-all
  ```

- [ ] **Step 2**: 复制核心代码
  - 从`monitor-doc/06-核心代码实现.md`复制代码
  - 创建`supabase/functions/scrape-site/index.ts`
  - 创建`supabase/functions/scrape-all/index.ts`

- [ ] **Step 3**: 安装依赖（如果需要）
  - Supabase Edge Functions使用Deno，大部分依赖通过URL导入
  - 确认Playwright for Deno可用

- [ ] **Step 4**: 本地测试
  ```bash
  cd supabase
  supabase functions serve scrape-site --no-verify-jwt
  
  # 在另一个终端测试
  curl -X POST http://localhost:54321/functions/v1/scrape-site \
    -H 'Content-Type: application/json' \
    -d '{"site_slug": "openrouter"}'
  ```

- [ ] **Step 5**: 调试和修复
  - 查看Edge Function日志
  - 修复任何错误或超时问题
  - 验证数据提取正确

- [ ] **Step 6**: 部署到Supabase
  ```bash
  supabase functions deploy scrape-site
  supabase functions deploy scrape-all
  ```

- [ ] **Step 7**: 验证部署
  ```bash
  # 测试已部署的函数
  curl -X POST https://ojbocxqvufoblihkzijn.supabase.co/functions/v1/scrape-site \
    -H 'Authorization: Bearer YOUR_ANON_KEY' \
    -H 'Content-Type: application/json' \
    -d '{"site_slug": "openrouter"}'
  ```

**预期结果**: 
- 返回HTTP 200
- 数据库中产生新记录
- Screenshot上传到Storage

---

### 阶段五：前端页面开发 (待完成)

- [ ] **Step 1**: 创建路由
  - 编辑`src/router/index.ts`
  - 添加`/monitor`路由

- [ ] **Step 2**: 创建MonitorView组件
  - 创建`src/views/MonitorView.vue`
  - 复制代码from `06-核心代码实现.md`

- [ ] **Step 3**: 创建MonitorCard组件
  - 创建`src/components/MonitorCard.vue`
  - 实现玻璃态样式

- [ ] **Step 4**: 实现数据获取逻辑
  - 从Supabase获取sites
  - 从Supabase获取records
  - 从Supabase获取cookies状态

- [ ] **Step 5**: 实现手动刷新功能
  - 单个卡片刷新按钮
  - 全部刷新按钮
  - Loading状态管理

- [ ] **Step 6**: 实现截图预览
  - Modal组件（或使用第三方库）
  - 点击缩略图显示大图

- [ ] **Step 7**: 样式调整
  - Glassmorphism效果
  - 响应式布局
  - 动画效果

- [ ] **Step 8**: 本地测试
  ```bash
  npm run dev
  # 访问 http://localhost:3000/monitor
  ```

- [ ] **Step 9**: 浏览器兼容性测试
  - Chrome/Edge
  - Firefox
  - Safari

**预期结果**:
- 页面正常加载
- 卡片显示数据
- Cookie状态指示器工作
- 刷新功能正常

---

### 阶段六：Vercel Cron配置 (待完成)

- [ ] **Step 1**: 创建API Route
  - 创建`api/cron/scrape-monitor.ts`
  - 复制代码from `06-核心代码实现.md`

- [ ] **Step 2**: 配置vercel.json
  ```json
  {
    "crons": [{
      "path": "/api/cron/scrape-monitor",
      "schedule": "0 1 * * *"
    }]
  }
  ```

- [ ] **Step 3**: 设置环境变量
  - 生成CRON_SECRET: `openssl rand -hex 32`
  - 在Vercel Dashboard设置环境变量

- [ ] **Step 4**: 部署到Vercel
  ```bash
  vercel login
  vercel deploy --prod
  ```

- [ ] **Step 5**: 在Vercel Dashboard验证
  - 访问Project Settings → Cron Jobs
  - 应该看到配置的定时任务

- [ ] **Step 6**: 手动测试Cron endpoint
  ```bash
  curl -X GET https://your-domain.vercel.app/api/cron/scrape-monitor \
    -H 'Authorization: Bearer YOUR_CRON_SECRET'
  ```

- [ ] **Step 7**: 等待实际执行
  - 在北京时间9:00-9:05之间检查
  - 查看数据库是否有新记录
  - 查看Storage是否有新截图

**预期结果**:
- Cron准时触发
- 3个网站都被抓取
- 数据库有3条新记录
- trigger_source='auto'

---

### 阶段七：测试和优化 (待完成)

- [ ] **功能测试**
  - [ ] TC-EF-002: OpenRouter数据抓取
  - [ ] TC-EF-003: TikHub数据抓取
  - [ ] TC-EF-004: Cursor数据抓取
  - [ ] TC-EF-005: Cookie有效性验证
  - [ ] TC-EF-006: 批量触发器测试

- [ ] **前端测试**
  - [ ] TC-FE-001: MonitorView页面渲染
  - [ ] TC-FE-002: 单个卡片手动触发
  - [ ] TC-FE-003: Cookie状态指示器
  - [ ] TC-FE-004: 数据展示格式化
  - [ ] TC-FE-005: 截图预览功能

- [ ] **定时任务测试**
  - [ ] TC-CRON-001: Vercel Cron配置
  - [ ] TC-CRON-002: API Route安全验证
  - [ ] TC-CRON-003: 端到端定时执行

- [ ] **性能优化**
  - [ ] 检查Edge Function执行时间
  - [ ] 优化截图大小（质量调整）
  - [ ] 前端加载性能优化
  - [ ] 图片懒加载

- [ ] **错误处理**
  - [ ] 网络超时重试
  - [ ] Cookie失效告警
  - [ ] 数据异常处理
  - [ ] 用户友好的错误提示

**预期结果**:
- 所有测试用例通过
- 性能指标达标
- 错误处理完善

---

## 🔍 验证检查点

### 数据库验证
```sql
-- 检查表结构
\d keep_monitor_sites
\d keep_monitor_cookies
\d keep_monitor_records

-- 检查数据
SELECT COUNT(*) FROM keep_monitor_sites;  -- 应该返回3
SELECT COUNT(*) FROM keep_monitor_cookies; -- 应该返回3
SELECT COUNT(*) FROM keep_monitor_records; -- 运行后应该>0
```

### Storage验证
```sql
-- 检查Bucket
SELECT * FROM storage.buckets WHERE name = 'monitor-screenshots';

-- 检查文件（运行后）
SELECT * FROM storage.objects WHERE bucket_id = 'monitor-screenshots';
```

### Edge Functions验证
```bash
# 列出已部署的函数
supabase functions list

# 查看函数日志
supabase functions logs scrape-site
```

### 前端验证
- [ ] /monitor 页面可访问
- [ ] 显示3个网站卡片
- [ ] 每个卡片有图标、名称、数据、截图、刷新按钮
- [ ] Cookie状态指示器显示正确颜色
- [ ] 点击刷新按钮有Loading状态
- [ ] 玻璃态效果正常显示
- [ ] 移动端响应式正常

### Vercel验证
- [ ] 项目成功部署
- [ ] 环境变量已设置
- [ ] Cron Jobs显示在Dashboard
- [ ] API Route可访问（带正确Authorization）

## 📊 完成度跟踪

| 阶段 | 进度 | 状态 |
|------|------|------|
| 设计和准备 | 100% | ✅ 完成 |
| 数据库初始化 | 100% | ✅ 完成 |
| Storage配置 | 0% | ⏸️ 待开始 |
| Edge Functions | 0% | ⏸️ 待开始 |
| 前端开发 | 0% | ⏸️ 待开始 |
| Vercel Cron | 0% | ⏸️ 待开始 |
| 测试优化 | 0% | ⏸️ 待开始 |
| **总体进度** | **28.6%** | 🏗️ 进行中 |

## 🎯 下一步行动

**立即可做**:
1. 创建Supabase Storage bucket
2. 开始编写Edge Functions代码
3. 本地测试Edge Functions

**预计时间线**:
- Storage配置: 15分钟
- Edge Functions开发: 3-4小时
- 前端开发: 2-3小时
- Vercel Cron配置: 1小时
- 测试和优化: 2-3小时

**预计完成日期**: 可在1-2个工作日内完成所有开发和测试

## 🚨 风险和注意事项

1. **Playwright在Edge Functions的兼容性**
   - 如果Playwright无法在Supabase Edge Functions中运行
   - 备选方案：使用GitHub Actions + Playwright
   - 需要及早测试验证

2. **Cloudflare验证问题**
   - TikHub使用Cloudflare保护
   - 可能需要更长的超时时间
   - 可能需要人工验证初次访问

3. **Cookie过期管理**
   - 需要建立Cookie更新流程
   - 考虑添加邮件告警
   - 提前7天提醒更新

4. **性能和费用**
   - Supabase免费额度：200万次Edge Function调用/月
   - Storage免费额度：1GB
   - Vercel免费额度：100GB带宽/月
   - 预计月费用：$0（在免费额度内）

## 📝 变更日志

- 2025-11-11: 完成设计阶段和数据库初始化
- 待更新: 后续阶段完成时更新

---

**重要提示**: 完成每个步骤后，在对应的checkbox打勾，并验证预期结果！

