# æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£

## æµ‹è¯•ç›®æ ‡

ç¡®ä¿è´¹ç”¨ç›‘æ§ç³»ç»Ÿçš„æ¯ä¸ªç»„ä»¶éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œæ•°æ®å‡†ç¡®å¯é ã€‚

## æµ‹è¯•ç¯å¢ƒ

- **æµ‹è¯•æ•°æ®åº“**: ä½¿ç”¨Supabaseæµ‹è¯•è¡¨ï¼ˆæ·»åŠ _teståç¼€ï¼‰
- **æµ‹è¯•Cookie**: ä½¿ç”¨ä¸“é—¨çš„æµ‹è¯•è´¦å·Cookie
- **æµ‹è¯•Storage**: ç‹¬ç«‹çš„test-screenshots bucket

## é˜¶æ®µä¸€ï¼šæ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•

### TC-DB-001: åˆ›å»ºè¡¨ç»“æ„
**ç›®æ ‡**: éªŒè¯3å¼ è¡¨èƒ½æˆåŠŸåˆ›å»º

**å‰ç½®æ¡ä»¶**: 
- è¿æ¥åˆ°Supabaseæ•°æ®åº“
- æœ‰CREATE TABLEæƒé™

**æµ‹è¯•æ­¥éª¤**:
1. æ‰§è¡Œkeep_monitor_sitesè¡¨åˆ›å»ºSQL
2. æ‰§è¡Œkeep_monitor_cookiesè¡¨åˆ›å»ºSQL
3. æ‰§è¡Œkeep_monitor_recordsè¡¨åˆ›å»ºSQL
4. åˆ›å»ºç´¢å¼•å’Œå¤–é”®çº¦æŸ

**é¢„æœŸç»“æœ**:
- âœ… æ‰€æœ‰è¡¨åˆ›å»ºæˆåŠŸ
- âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ
- âœ… å¤–é”®çº¦æŸç”Ÿæ•ˆ
- âœ… é»˜è®¤å€¼æ­£ç¡®

**éªŒè¯SQL**:
```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name LIKE 'keep_monitor_%';

-- é¢„æœŸè¿”å›3æ¡è®°å½•:
-- keep_monitor_sites
-- keep_monitor_cookies  
-- keep_monitor_records
```

**æµ‹è¯•æ•°æ®**:
```sql
-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO keep_monitor_sites (name, slug, url, scraper_config)
VALUES ('Test Site', 'test', 'https://example.com', '{}');

-- éªŒè¯æ’å…¥æˆåŠŸ
SELECT * FROM keep_monitor_sites WHERE slug = 'test';
```

**æ£€æµ‹æ–¹å¼**: 
- é€šè¿‡MCPæ‰§è¡Œ`list_tables`æŸ¥çœ‹è¡¨åˆ—è¡¨
- æ’å…¥æµ‹è¯•æ•°æ®éªŒè¯çº¦æŸ

---

### TC-DB-002: å¯¼å…¥Cookieæ•°æ®
**ç›®æ ‡**: éªŒè¯Cookieæ•°æ®èƒ½æ­£ç¡®å¯¼å…¥å’Œå­˜å‚¨

**å‰ç½®æ¡ä»¶**:
- keep_monitor_cookiesè¡¨å·²åˆ›å»º
- keep_monitor_sitesè¡¨å·²æœ‰3ä¸ªç½‘ç«™è®°å½•

**æµ‹è¯•æ­¥éª¤**:
1. è¯»å–cookies-temp/openrouteræ–‡ä»¶
2. è½¬æ¢ä¸ºJSONæ ¼å¼
3. æ’å…¥åˆ°keep_monitor_cookiesè¡¨
4. é‡å¤2-3æ­¥éª¤å¤„ç†tikhubå’Œcursor

**é¢„æœŸç»“æœ**:
- âœ… 3ä¸ªç½‘ç«™çš„Cookieéƒ½æˆåŠŸå¯¼å…¥
- âœ… JSONæ ¼å¼æ­£ç¡®ï¼Œå¯ä»¥è¢«è§£æ
- âœ… expires_atå­—æ®µæ­£ç¡®è®¡ç®—

**éªŒè¯SQL**:
```sql
SELECT 
  site_slug,
  jsonb_array_length(cookies) as cookie_count,
  is_valid,
  expires_at
FROM keep_monitor_cookies;

-- é¢„æœŸè¿”å›:
-- openrouter | 10 | true | 2026-xx-xx
-- tikhub     | 7  | true | 2025-xx-xx  
-- cursor     | 5  | true | 2026-xx-xx
```

**æµ‹è¯•æ•°æ®**:
```json
{
  "site_slug": "test",
  "cookies": [
    {
      "name": "test_cookie",
      "value": "test_value",
      "domain": ".example.com",
      "path": "/",
      "expires": 1735689600,
      "httpOnly": false,
      "secure": true
    }
  ],
  "is_valid": true,
  "expires_at": "2025-01-01T00:00:00Z"
}
```

**æ£€æµ‹æ–¹å¼**:
- MCP execute_sqlæŸ¥è¯¢Cookieè®°å½•
- éªŒè¯JSONæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆå¯è¢«æµè§ˆå™¨æ¥å—ï¼‰

---

### TC-DB-003: åˆ›å»ºStorage Bucket
**ç›®æ ‡**: éªŒè¯Supabase Storage bucketåˆ›å»ºæˆåŠŸ

**å‰ç½®æ¡ä»¶**:
- æœ‰Storageç®¡ç†æƒé™

**æµ‹è¯•æ­¥éª¤**:
1. é€šè¿‡SQLæˆ–Dashboardåˆ›å»ºmonitor-screenshots bucket
2. è®¾ç½®ä¸ºpublicè®¿é—®
3. åˆ›å»ºRLSç­–ç•¥å…è®¸publicè¯»å–

**é¢„æœŸç»“æœ**:
- âœ… Bucketåˆ›å»ºæˆåŠŸ
- âœ… å¯ä»¥é€šè¿‡Dashboardçœ‹åˆ°bucket
- âœ… Public URLå¯è®¿é—®

**éªŒè¯æ–¹æ³•**:
```sql
SELECT * FROM storage.buckets WHERE name = 'monitor-screenshots';
```

**æ‰‹åŠ¨éªŒè¯**:
- è®¿é—® https://supabase.com/dashboard/project/ojbocxqvufoblihkzijn/storage/buckets
- åº”è¯¥çœ‹åˆ°monitor-screenshots bucket

**æµ‹è¯•ä¸Šä¼ **:
```typescript
const { data, error } = await supabase.storage
  .from('monitor-screenshots')
  .upload('test/hello.txt', new Blob(['Hello World']));

if (error) console.error('ä¸Šä¼ å¤±è´¥:', error);
else console.log('ä¸Šä¼ æˆåŠŸ:', data.path);
```

**æ£€æµ‹æ–¹å¼**:
- ä¸Šä¼ æµ‹è¯•æ–‡ä»¶
- è®¿é—®public URLéªŒè¯å¯ä¸‹è½½

---

## é˜¶æ®µäºŒï¼šEdge Functionså¼€å‘æµ‹è¯•

### TC-EF-001: é€šç”¨æŠ“å–å™¨åŸºç¡€åŠŸèƒ½
**ç›®æ ‡**: éªŒè¯scrape-site Edge Functionèƒ½æ­£å¸¸å¯åŠ¨

**å‰ç½®æ¡ä»¶**:
- Edge Functionå·²éƒ¨ç½²
- æœ‰è°ƒç”¨æƒé™

**æµ‹è¯•æ­¥éª¤**:
1. ä½¿ç”¨æœ€ç®€é…ç½®è°ƒç”¨Edge Function
2. ä¼ å…¥testç½‘ç«™slug
3. æ£€æŸ¥è¿”å›ç»“æœ

**æµ‹è¯•è¯·æ±‚**:
```bash
curl -X POST \
  'https://ojbocxqvufoblihkzijn.supabase.co/functions/v1/scrape-site' \
  -H 'Authorization: Bearer YOUR_ANON_KEY' \
  -H 'Content-Type: application/json' \
  -d '{"site_slug": "openrouter", "validate_only": false}'
```

**é¢„æœŸç»“æœ**:
- âœ… HTTP 200çŠ¶æ€ç 
- âœ… è¿”å›JSONæ ¼å¼æ•°æ®
- âœ… åŒ…å«dataã€screenshot_urlã€durationå­—æ®µ

**é”™è¯¯æƒ…å†µæµ‹è¯•**:
```json
// æµ‹è¯•ä¸å­˜åœ¨çš„ç½‘ç«™
{"site_slug": "nonexistent"}
// é¢„æœŸ: 404 Not Found, "Site not found"

// æµ‹è¯•æ— æ•ˆçš„å‚æ•°
{"site_slug": null}
// é¢„æœŸ: 400 Bad Request, "Invalid parameters"
```

**æ£€æµ‹æ–¹å¼**:
- æŸ¥çœ‹Edge Functionæ—¥å¿—
- éªŒè¯è¿”å›æ•°æ®ç»“æ„

---

### TC-EF-002: OpenRouteræ•°æ®æŠ“å–
**ç›®æ ‡**: éªŒè¯èƒ½æ­£ç¡®æŠ“å–OpenRouterçš„Creditsæ•°æ®

**å‰ç½®æ¡ä»¶**:
- OpenRouter Cookieæœ‰æ•ˆ
- é…ç½®å·²å¯¼å…¥æ•°æ®åº“

**æµ‹è¯•æ­¥éª¤**:
1. è°ƒç”¨scrape-siteï¼Œä¼ å…¥site_slug="openrouter"
2. ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆçº¦10ç§’ï¼‰
3. æ£€æŸ¥è¿”å›çš„dataå­—æ®µ
4. æ£€æŸ¥screenshotæ˜¯å¦ä¸Šä¼ æˆåŠŸ

**é¢„æœŸç»“æœ**:
```json
{
  "status": "success",
  "data": {
    "credits": 7.73,
    "usage_info": "...",
    "scraped_at": "2025-11-11T09:00:00Z"
  },
  "screenshot_url": "monitor-screenshots/openrouter/latest.png",
  "duration": 8500,
  "cookie_valid": true
}
```

**éªŒè¯ç‚¹**:
- âœ… creditså­—æ®µæ˜¯æ•°å­—ç±»å‹
- âœ… æ•°å€¼åˆç†ï¼ˆ0-1000èŒƒå›´ï¼‰
- âœ… screenshot_urlå¯è®¿é—®
- âœ… durationå°äº30ç§’

**SQLéªŒè¯**:
```sql
SELECT * FROM keep_monitor_records 
WHERE site_slug = 'openrouter' 
ORDER BY created_at DESC 
LIMIT 1;
```

**æ£€æµ‹æ–¹å¼**:
- å¯¹æ¯”æ‰‹åŠ¨è®¿é—®ç½‘é¡µçœ‹åˆ°çš„æ•°å€¼
- ä¸‹è½½æˆªå›¾éªŒè¯å†…å®¹æ­£ç¡®

---

### TC-EF-003: TikHubæ•°æ®æŠ“å–
**ç›®æ ‡**: éªŒè¯èƒ½æ­£ç¡®æŠ“å–TikHubçš„å¤šä¸ªå­—æ®µ

**å‰ç½®æ¡ä»¶**:
- TikHub Cookieæœ‰æ•ˆ
- èƒ½é€šè¿‡CloudflareéªŒè¯

**æµ‹è¯•æ­¥éª¤**:
1. è°ƒç”¨scrape-siteï¼Œä¼ å…¥site_slug="tikhub"
2. ç­‰å¾…CloudflareéªŒè¯å’Œæ•°æ®åŠ è½½
3. æ£€æŸ¥è¿”å›æ•°æ®çš„å®Œæ•´æ€§

**é¢„æœŸç»“æœ**:
```json
{
  "status": "success",
  "data": {
    "balance": 9.0416,
    "free_credit": 0.0006,
    "api_requests_today": 2,
    "daily_cost": 0.0020,
    "last_check_in": "2025-06-05",
    "check_in_status": "Not Check-in",
    "scraped_at": "2025-11-11T09:00:00Z"
  },
  "screenshot_url": "monitor-screenshots/tikhub/latest.png",
  "duration": 15000,
  "cookie_valid": true
}
```

**ç‰¹æ®Šæƒ…å†µ**:
- CloudflareéªŒè¯è¶…æ—¶ï¼šåº”é‡è¯•æœ€å¤š3æ¬¡
- éƒ¨åˆ†å­—æ®µç¼ºå¤±ï¼šå¯é€‰å­—æ®µå…è®¸null

**æ£€æµ‹æ–¹å¼**:
- éªŒè¯balance + free_creditçš„æ€»å’Œ
- éªŒè¯api_requests_todayæ˜¯éè´Ÿæ•´æ•°
- æ£€æŸ¥æˆªå›¾æ˜¯å¦åŒ…å«Dashboardå†…å®¹

---

### TC-EF-004: Cursoræ•°æ®æŠ“å–
**ç›®æ ‡**: éªŒè¯èƒ½æ­£ç¡®æŠ“å–Cursorçš„ä½¿ç”¨é…é¢

**å‰ç½®æ¡ä»¶**:
- Cursor Cookieæœ‰æ•ˆ
- WorkOSè®¤è¯æœªè¿‡æœŸ

**æµ‹è¯•æ­¥éª¤**:
1. è°ƒç”¨scrape-siteï¼Œä¼ å…¥site_slug="cursor"
2. æ£€æŸ¥included_usageå’Œon_demand_usage

**é¢„æœŸç»“æœ**:
```json
{
  "status": "success",
  "data": {
    "included_usage": {
      "used": 87,
      "total": 500,
      "percentage": 17.4
    },
    "on_demand_usage": {
      "spent": 1,
      "limit": 10,
      "percentage": 10.0
    },
    "reset_date": "2025-12-04",
    "scraped_at": "2025-11-11T09:00:00Z"
  },
  "screenshot_url": "monitor-screenshots/cursor/latest.png",
  "duration": 7000,
  "cookie_valid": true
}
```

**è®¡ç®—éªŒè¯**:
- âœ… percentage = (used / total) * 100
- âœ… 87 / 500 * 100 = 17.4

**æ£€æµ‹æ–¹å¼**:
- æ‰‹åŠ¨ç™»å½•Cursor Dashboardå¯¹æ¯”æ•°æ®
- éªŒè¯ç™¾åˆ†æ¯”è®¡ç®—æ­£ç¡®

---

### TC-EF-005: Cookieæœ‰æ•ˆæ€§éªŒè¯
**ç›®æ ‡**: éªŒè¯Cookieå¤±æ•ˆæ—¶èƒ½æ­£ç¡®æ£€æµ‹

**å‰ç½®æ¡ä»¶**:
- å‡†å¤‡ä¸€ä¸ªå·²è¿‡æœŸçš„Cookie

**æµ‹è¯•æ­¥éª¤**:
1. ä¿®æ”¹æ•°æ®åº“ä¸­çš„Cookieä¸ºè¿‡æœŸå€¼
2. è°ƒç”¨scrape-site
3. æ£€æŸ¥è¿”å›çš„cookie_validå­—æ®µ

**é¢„æœŸç»“æœ**:
```json
{
  "status": "cookie_invalid",
  "data": null,
  "screenshot_url": null,
  "duration": 5000,
  "cookie_valid": false,
  "error": "æ£€æµ‹åˆ°ç™»å½•é¡µé¢ï¼ŒCookieå·²å¤±æ•ˆ"
}
```

**æ•°æ®åº“æ›´æ–°**:
```sql
UPDATE keep_monitor_cookies
SET is_valid = false,
    last_validated_at = NOW()
WHERE site_slug = 'openrouter';
```

**æ£€æµ‹æ–¹å¼**:
- éªŒè¯status='cookie_invalid'
- éªŒè¯æ•°æ®åº“ä¸­is_validè¢«æ›´æ–°ä¸ºfalse

---

### TC-EF-006: æ‰¹é‡è§¦å‘å™¨æµ‹è¯•
**ç›®æ ‡**: éªŒè¯scrape-allèƒ½å¹¶è¡Œè°ƒç”¨å¤šä¸ªç½‘ç«™

**å‰ç½®æ¡ä»¶**:
- æ‰€æœ‰å•ä¸ªç½‘ç«™çš„æŠ“å–åŠŸèƒ½éƒ½æ­£å¸¸

**æµ‹è¯•æ­¥éª¤**:
1. è°ƒç”¨scrape-all Edge Function
2. è§‚å¯Ÿå¹¶å‘æ‰§è¡Œæƒ…å†µ
3. æ£€æŸ¥æ¯ä¸ªç½‘ç«™çš„ç»“æœ

**æµ‹è¯•è¯·æ±‚**:
```bash
curl -X POST \
  'https://ojbocxqvufoblihkzijn.supabase.co/functions/v1/scrape-all' \
  -H 'Authorization: Bearer YOUR_SERVICE_ROLE_KEY' \
  -H 'Content-Type: application/json'
```

**é¢„æœŸç»“æœ**:
```json
{
  "success": true,
  "results": [
    {"site": "openrouter", "status": "success"},
    {"site": "tikhub", "status": "success"},
    {"site": "cursor", "status": "success"}
  ],
  "total_duration": 15000
}
```

**æ€§èƒ½è¦æ±‚**:
- âœ… æ€»è€—æ—¶ < 20ç§’ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
- âœ… æ‰€æœ‰ç½‘ç«™status='success'

**æ£€æµ‹æ–¹å¼**:
- å¯¹æ¯”å•ä¸ªæ‰§è¡Œvså¹¶è¡Œæ‰§è¡Œçš„æ—¶é—´
- éªŒè¯3ä¸ªç½‘ç«™éƒ½æœ‰æ–°è®°å½•ç”Ÿæˆ

---

## é˜¶æ®µä¸‰ï¼šå‰ç«¯é¡µé¢æµ‹è¯•

### TC-FE-001: MonitorViewé¡µé¢æ¸²æŸ“
**ç›®æ ‡**: éªŒè¯ç›‘æ§é¡µé¢èƒ½æ­£ç¡®åŠ è½½å’Œæ˜¾ç¤º

**å‰ç½®æ¡ä»¶**:
- æ•°æ®åº“ä¸­æœ‰è‡³å°‘1æ¡è®°å½•
- å‰ç«¯å·²éƒ¨ç½²

**æµ‹è¯•æ­¥éª¤**:
1. è®¿é—® /monitor é¡µé¢
2. æ£€æŸ¥é¡µé¢å…ƒç´ æ˜¯å¦æ˜¾ç¤º

**é¢„æœŸç»“æœ**:
- âœ… é¡µé¢æ ‡é¢˜æ˜¾ç¤º
- âœ… 3ä¸ªç½‘ç«™å¡ç‰‡éƒ½æ¸²æŸ“
- âœ… å¡ç‰‡æœ‰ç»ç’ƒæ€æ•ˆæœ
- âœ… CookieçŠ¶æ€æŒ‡ç¤ºå™¨æ˜¾ç¤ºï¼ˆç»¿ç‚¹/çº¢ç‚¹ï¼‰

**æ‰‹åŠ¨æ£€æŸ¥æ¸…å•**:
- [ ] é¡µé¢èƒŒæ™¯æœ‰æ¸å˜åŠ¨ç”»
- [ ] å¡ç‰‡æœ‰æ¨¡ç³ŠèƒŒæ™¯æ•ˆæœï¼ˆbackdrop-filterï¼‰
- [ ] Hoverå¡ç‰‡æ—¶æœ‰é˜´å½±å’Œä¸Šæµ®åŠ¨ç”»
- [ ] åŠ è½½åŠ¨ç”»æ˜¾ç¤ºæ­£å¸¸

**æµè§ˆå™¨å…¼å®¹æ€§**:
- Chrome/Edge æœ€æ–°ç‰ˆ
- Firefox æœ€æ–°ç‰ˆ
- Safari 16+

**æ£€æµ‹æ–¹å¼**:
- æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹CSS
- éªŒè¯backdrop-filterç”Ÿæ•ˆ

---

### TC-FE-002: å•ä¸ªå¡ç‰‡æ‰‹åŠ¨è§¦å‘
**ç›®æ ‡**: éªŒè¯ç‚¹å‡»å¡ç‰‡çš„åˆ·æ–°æŒ‰é’®èƒ½è§¦å‘æŠ“å–

**å‰ç½®æ¡ä»¶**:
- MonitorViewé¡µé¢å·²æ‰“å¼€

**æµ‹è¯•æ­¥éª¤**:
1. ç‚¹å‡»OpenRouterå¡ç‰‡çš„åˆ·æ–°æŒ‰é’®
2. è§‚å¯ŸLoadingçŠ¶æ€
3. ç­‰å¾…ç»“æœè¿”å›

**é¢„æœŸç»“æœ**:
- âœ… æŒ‰é’®å˜ä¸ºLoadingçŠ¶æ€ï¼ˆç¦ç”¨+æ—‹è½¬å›¾æ ‡ï¼‰
- âœ… 5-10ç§’åæ˜¾ç¤ºæœ€æ–°æ•°æ®
- âœ… å¡ç‰‡åº•éƒ¨æ—¶é—´æˆ³æ›´æ–°
- âœ… æˆªå›¾æ›´æ–°ï¼ˆå¦‚æœæœ‰ï¼‰

**é”™è¯¯æƒ…å†µ**:
- ç½‘ç»œé”™è¯¯ï¼šæ˜¾ç¤º"ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•"
- Cookieå¤±æ•ˆï¼šæ˜¾ç¤º"Cookieå·²å¤±æ•ˆï¼Œè¯·æ›´æ–°"ï¼Œçº¢ç‚¹äº®èµ·

**æ£€æµ‹æ–¹å¼**:
- å¯¹æ¯”åˆ·æ–°å‰åçš„æ•°æ®å˜åŒ–
- æ£€æŸ¥Networké¢æ¿çš„è¯·æ±‚

---

### TC-FE-003: CookieçŠ¶æ€æŒ‡ç¤ºå™¨
**ç›®æ ‡**: éªŒè¯CookieçŠ¶æ€èƒ½æ­£ç¡®æ˜¾ç¤º

**å‰ç½®æ¡ä»¶**:
- æœ‰æœ‰æ•ˆå’Œæ— æ•ˆCookieçš„æµ‹è¯•æ•°æ®

**æµ‹è¯•æ­¥éª¤**:
1. æŸ¥çœ‹3ä¸ªå¡ç‰‡çš„CookieçŠ¶æ€ç‚¹
2. ä¿®æ”¹æ•°æ®åº“ä¸­æŸä¸ªCookieä¸ºæ— æ•ˆ
3. åˆ·æ–°é¡µé¢è§‚å¯Ÿå˜åŒ–

**é¢„æœŸç»“æœ**:
```
æœ‰æ•ˆCookie: ğŸŸ¢ ç»¿è‰²å‘å…‰ç‚¹ï¼Œæœ‰è„‰å†²åŠ¨ç”»
æ— æ•ˆCookie: ğŸ”´ çº¢è‰²å‘å…‰ç‚¹ï¼Œæœ‰è„‰å†²åŠ¨ç”»
```

**CSSéªŒè¯**:
```css
.cookie-status.valid {
  background: rgba(52, 211, 153, 0.9);
  box-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
}

.cookie-status.invalid {
  background: rgba(248, 113, 113, 0.9);
  box-shadow: 0 0 10px rgba(248, 113, 113, 0.5);
}
```

**æ£€æµ‹æ–¹å¼**:
- è§†è§‰æ£€æŸ¥é¢œè‰²å’ŒåŠ¨ç”»
- é¼ æ ‡æ‚¬åœæ˜¾ç¤ºtooltipè¯´æ˜

---

### TC-FE-004: æ•°æ®å±•ç¤ºæ ¼å¼åŒ–
**ç›®æ ‡**: éªŒè¯æ•°æ®èƒ½æ­£ç¡®æ ¼å¼åŒ–æ˜¾ç¤º

**å‰ç½®æ¡ä»¶**:
- æ•°æ®åº“ä¸­æœ‰å®Œæ•´çš„è®°å½•

**æµ‹è¯•ç”¨ä¾‹**:
| åŸå§‹æ•°æ® | é¢„æœŸæ˜¾ç¤º |
|---------|---------|
| credits: 7.73 | $7.73 |
| balance: 9.0416 | $9.04 |
| used: 87, total: 500 | 87 / 500 (17.4%) |
| spent: 1, limit: 10 | $1 / $10 (10%) |

**æ•°å­—æ ¼å¼è¦æ±‚**:
- é‡‘é¢ï¼šä¿ç•™2ä½å°æ•°ï¼Œæ·»åŠ $ç¬¦å·
- ç™¾åˆ†æ¯”ï¼šä¿ç•™1ä½å°æ•°ï¼Œæ·»åŠ %ç¬¦å·
- æ—¥æœŸï¼šæ˜¾ç¤ºä¸º"åˆšåˆš"/"5åˆ†é’Ÿå‰"/"ä»Šå¤©09:00"/"æ˜¨å¤©"

**æ£€æµ‹æ–¹å¼**:
- éªŒè¯æ•°å­—æ ¼å¼ç¬¦åˆè¦æ±‚
- æµ‹è¯•æç«¯å€¼ï¼ˆ0, 0.01, 999.99ï¼‰

---

### TC-FE-005: æˆªå›¾é¢„è§ˆåŠŸèƒ½
**ç›®æ ‡**: éªŒè¯ç‚¹å‡»æˆªå›¾èƒ½æ”¾å¤§æŸ¥çœ‹

**å‰ç½®æ¡ä»¶**:
- å¡ç‰‡ä¸­æœ‰æˆªå›¾ç¼©ç•¥å›¾

**æµ‹è¯•æ­¥éª¤**:
1. ç‚¹å‡»å¡ç‰‡åº•éƒ¨çš„æˆªå›¾ç¼©ç•¥å›¾
2. å¼¹å‡ºModalæ˜¾ç¤ºå¤§å›¾
3. ç‚¹å‡»å…³é—­æˆ–é®ç½©å±‚å…³é—­Modal

**é¢„æœŸç»“æœ**:
- âœ… Modalä»¥åŠ¨ç”»æ–¹å¼å¼¹å‡º
- âœ… å¤§å›¾æ¸…æ™°å¯è§
- âœ… æœ‰å…³é—­æŒ‰é’®å’Œå¿«æ·é”®ï¼ˆESCï¼‰
- âœ… ç‚¹å‡»é®ç½©å±‚å¯å…³é—­

**æ— éšœç¢è¦æ±‚**:
- Tabé”®å¯ä»¥èšç„¦åˆ°å…³é—­æŒ‰é’®
- ESCé”®å¯å…³é—­Modal
- æœ‰é€‚å½“çš„ARIAæ ‡ç­¾

**æ£€æµ‹æ–¹å¼**:
- æ‰‹åŠ¨æ“ä½œéªŒè¯
- ä½¿ç”¨æ— éšœç¢æ£€æµ‹å·¥å…·

---

## é˜¶æ®µå››ï¼šå®šæ—¶ä»»åŠ¡æµ‹è¯•

### TC-CRON-001: Vercel Croné…ç½®
**ç›®æ ‡**: éªŒè¯Vercel Cronèƒ½æ­£ç¡®è§¦å‘

**å‰ç½®æ¡ä»¶**:
- vercel.jsonå·²é…ç½®cron
- API Routeå·²åˆ›å»º

**é…ç½®éªŒè¯**:
```json
{
  "crons": [{
    "path": "/api/cron/scrape-monitor",
    "schedule": "0 1 * * *"
  }]
}
```

**æµ‹è¯•æ­¥éª¤**:
1. éƒ¨ç½²åˆ°Vercel
2. åœ¨Vercel DashboardæŸ¥çœ‹Croné…ç½®
3. æ‰‹åŠ¨è§¦å‘æµ‹è¯•ï¼ˆå¦‚æœæ”¯æŒï¼‰

**é¢„æœŸç»“æœ**:
- âœ… Vercel Dashboardæ˜¾ç¤ºCroné…ç½®
- âœ… Scheduleæ˜¾ç¤ºä¸º"0 1 * * *" (UTC 1ç‚¹)
- âœ… ç›¸å½“äºåŒ—äº¬æ—¶é—´9ç‚¹

**æ—¶åŒºè½¬æ¢éªŒè¯**:
```
UTC 1:00 = Beijing 9:00 âœ…
UTC 0:00 = Beijing 8:00 âŒ
UTC 2:00 = Beijing 10:00 âŒ
```

**æ£€æµ‹æ–¹å¼**:
- æŸ¥çœ‹Vercel Dashboardçš„Cronåˆ—è¡¨
- ç­‰å¾…å®é™…æ‰§è¡Œæ—¶é—´éªŒè¯

---

### TC-CRON-002: API Routeå®‰å…¨éªŒè¯
**ç›®æ ‡**: éªŒè¯åªæœ‰Vercel Cronèƒ½è°ƒç”¨API

**å‰ç½®æ¡ä»¶**:
- CRON_SECRETå·²è®¾ç½®

**æµ‹è¯•æ­¥éª¤**:
1. ä¸å¸¦Authorization headerè®¿é—®API
2. å¸¦é”™è¯¯çš„Authorization headerè®¿é—®
3. å¸¦æ­£ç¡®çš„Authorization headerè®¿é—®

**æµ‹è¯•è¯·æ±‚**:
```bash
# æµ‹è¯•1: æ— Authorization
curl -X GET 'https://your-domain.vercel.app/api/cron/scrape-monitor'
# é¢„æœŸ: 401 Unauthorized

# æµ‹è¯•2: é”™è¯¯çš„secret
curl -X GET 'https://your-domain.vercel.app/api/cron/scrape-monitor' \
  -H 'Authorization: Bearer wrong-secret'
# é¢„æœŸ: 401 Unauthorized

# æµ‹è¯•3: æ­£ç¡®çš„secret
curl -X GET 'https://your-domain.vercel.app/api/cron/scrape-monitor' \
  -H 'Authorization: Bearer correct-secret'
# é¢„æœŸ: 200 OK
```

**å®‰å…¨è¦æ±‚**:
- âœ… æ— æ•ˆè¯·æ±‚è¿”å›401ï¼Œä¸æ³„éœ²ä¿¡æ¯
- âœ… æˆåŠŸè¯·æ±‚è¿”å›200å’Œæ‰§è¡Œç»“æœ
- âœ… æ—¥å¿—è®°å½•æ‰€æœ‰è®¿é—®ï¼ˆåŒ…æ‹¬å¤±è´¥çš„ï¼‰

**æ£€æµ‹æ–¹å¼**:
- ä½¿ç”¨curlæµ‹è¯•ä¸åŒæƒ…å†µ
- æŸ¥çœ‹Vercelæ—¥å¿—

---

### TC-CRON-003: ç«¯åˆ°ç«¯å®šæ—¶æ‰§è¡Œ
**ç›®æ ‡**: éªŒè¯å®Œæ•´çš„å®šæ—¶ä»»åŠ¡æµç¨‹

**å‰ç½®æ¡ä»¶**:
- æ‰€æœ‰ç»„ä»¶éƒ½å·²éƒ¨ç½²å’Œé…ç½®

**æ‰§è¡Œæµç¨‹**:
```
Vercel Cronè§¦å‘ 
  â†’ API RouteéªŒè¯
  â†’ è°ƒç”¨Supabase scrape-all
  â†’ å¹¶è¡Œæ‰§è¡Œ3ä¸ªscrape-site
  â†’ ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“
  â†’ ä¸Šä¼ æˆªå›¾åˆ°Storage
  â†’ æ›´æ–°CookieçŠ¶æ€
```

**éªŒè¯ç‚¹**:
1. **æ—¶é—´éªŒè¯**: åœ¨é¢„å®šæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´9ç‚¹ï¼‰æ‰§è¡Œ
2. **æ•°æ®éªŒè¯**: æ•°æ®åº“ä¸­äº§ç”Ÿ3æ¡æ–°è®°å½•
3. **æˆªå›¾éªŒè¯**: Storageä¸­çš„å›¾ç‰‡è¢«æ›´æ–°
4. **çŠ¶æ€éªŒè¯**: CookieçŠ¶æ€æ­£ç¡®æ›´æ–°

**SQLéªŒè¯**:
```sql
-- æŸ¥çœ‹ä»Šå¤©9ç‚¹å·¦å³çš„è®°å½•
SELECT 
  site_slug,
  status,
  trigger_source,
  created_at
FROM keep_monitor_records
WHERE created_at BETWEEN 
  '2025-11-11 01:00:00'  -- UTCæ—¶é—´
  AND '2025-11-11 01:10:00'
ORDER BY created_at;

-- é¢„æœŸ: 3æ¡è®°å½•ï¼Œtrigger_source='auto'
```

**æ£€æµ‹æ–¹å¼**:
- è®¾ç½®é—¹é’Ÿåœ¨åŒ—äº¬æ—¶é—´9:01æŸ¥çœ‹
- å¯¹æ¯”å‰åæ•°æ®åº“è®°å½•
- æ£€æŸ¥Storageæ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´

---

## é˜¶æ®µäº”ï¼šé›†æˆæµ‹è¯•å’Œè¾¹ç•Œæµ‹è¯•

### TC-INT-001: ç½‘ç»œå¼‚å¸¸å¤„ç†
**ç›®æ ‡**: éªŒè¯ç½‘ç»œé”™è¯¯æ—¶çš„é‡è¯•æœºåˆ¶

**æµ‹è¯•åœºæ™¯**:
1. ç›®æ ‡ç½‘ç«™æ— å“åº”ï¼ˆè¶…æ—¶ï¼‰
2. ç½‘ç»œé—´æ­‡æ€§æ–­å¼€
3. 503 Service Unavailable

**é¢„æœŸè¡Œä¸º**:
- âœ… è‡ªåŠ¨é‡è¯•2-3æ¬¡
- âœ… æ¯æ¬¡é‡è¯•é—´éš”5-10ç§’
- âœ… æœ€ç»ˆå¤±è´¥åè®°å½•é”™è¯¯
- âœ… ä¸å½±å“å…¶ä»–ç½‘ç«™çš„æŠ“å–

**éªŒè¯æ•°æ®**:
```json
{
  "status": "failed",
  "error_message": "Network timeout after 3 retries",
  "scrape_duration": 45000
}
```

**æ£€æµ‹æ–¹å¼**:
- æ‰‹åŠ¨æ–­ç½‘æµ‹è¯•
- ä½¿ç”¨mockæ•°æ®æ¨¡æ‹Ÿtimeout

---

### TC-INT-002: æ•°æ®å¼‚å¸¸å¤„ç†
**ç›®æ ‡**: éªŒè¯é¡µé¢ç»“æ„å˜åŒ–æ—¶çš„å¤„ç†

**æµ‹è¯•åœºæ™¯**:
1. ç›®æ ‡å…ƒç´ ä¸å­˜åœ¨
2. æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ
3. é¡µé¢å®Œå…¨æ”¹ç‰ˆ

**é¢„æœŸè¡Œä¸º**:
- âœ… è®°å½•error_messageè¯´æ˜é—®é¢˜
- âœ… å°½å¯èƒ½æå–éƒ¨åˆ†æ•°æ®
- âœ… å¯é€‰å­—æ®µå…è®¸ç¼ºå¤±
- âœ… å‘é€å‘Šè­¦é€šçŸ¥ç®¡ç†å‘˜

**é”™è¯¯ç¤ºä¾‹**:
```json
{
  "status": "partial_success",
  "data": {
    "credits": 7.73,
    "usage_info": null  // æå–å¤±è´¥
  },
  "error_message": "usage_info element not found"
}
```

**æ£€æµ‹æ–¹å¼**:
- ä¿®æ”¹scraper_configä½¿ç”¨é”™è¯¯çš„selector
- è§‚å¯Ÿé”™è¯¯å¤„ç†é€»è¾‘

---

### TC-INT-003: é«˜å¹¶å‘æµ‹è¯•
**ç›®æ ‡**: éªŒè¯ç³»ç»Ÿèƒ½å¤„ç†å¤šæ¬¡åŒæ—¶è§¦å‘

**æµ‹è¯•åœºæ™¯**:
- æ‰‹åŠ¨è§¦å‘ + å®šæ—¶ä»»åŠ¡åŒæ—¶æ‰§è¡Œ
- çŸ­æ—¶é—´å†…å¤šæ¬¡ç‚¹å‡»åˆ·æ–°

**æµ‹è¯•æ­¥éª¤**:
1. åœ¨09:00:00å®šæ—¶ä»»åŠ¡è§¦å‘æ—¶
2. åŒæ—¶æ‰‹åŠ¨ç‚¹å‡»3ä¸ªå¡ç‰‡åˆ·æ–°
3. è§‚å¯Ÿæ˜¯å¦æœ‰å†²çª

**é¢„æœŸè¡Œä¸º**:
- âœ… Edge Functionèƒ½å¤„ç†å¹¶å‘è¯·æ±‚
- âœ… æ•°æ®åº“ä¸ä¼šäº§ç”Ÿå†²çª
- âœ… æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹å®Œæˆ

**æ£€æµ‹æ–¹å¼**:
- æŸ¥çœ‹æ•°æ®åº“è®°å½•æ•°é‡
- éªŒè¯trigger_sourceå­—æ®µ
- æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤è®°å½•

---

### TC-PERF-001: æ€§èƒ½åŸºå‡†æµ‹è¯•
**ç›®æ ‡**: éªŒè¯ç³»ç»Ÿæ€§èƒ½ç¬¦åˆè¦æ±‚

**æ€§èƒ½æŒ‡æ ‡**:
| æŒ‡æ ‡ | è¦æ±‚ | æµ‹é‡æ–¹æ³• |
|------|------|---------|
| å•ä¸ªç½‘ç«™æŠ“å–æ—¶é—´ | < 10ç§’ | Edge Function duration |
| 3ä¸ªç½‘ç«™å¹¶è¡Œæ—¶é—´ | < 20ç§’ | scrape-all total_duration |
| å‰ç«¯é¡µé¢åŠ è½½æ—¶é—´ | < 2ç§’ | Chrome DevTools |
| æ‰‹åŠ¨è§¦å‘å“åº”æ—¶é—´ | < 1ç§’ | æŒ‰é’®å˜Loadingçš„å»¶è¿Ÿ |
| æˆªå›¾å¤§å° | < 500KB | Storageæ–‡ä»¶å¤§å° |

**å‹åŠ›æµ‹è¯•**:
- è¿ç»­10æ¬¡æ‰‹åŠ¨è§¦å‘ï¼Œè§‚å¯Ÿç¨³å®šæ€§
- æ¨¡æ‹Ÿ10ä¸ªå¹¶å‘ç”¨æˆ·è®¿é—®Monitoré¡µé¢

**æ£€æµ‹æ–¹å¼**:
- ä½¿ç”¨Chrome DevToolsçš„Performanceé¢æ¿
- è®°å½•å¤šæ¬¡æµ‹é‡çš„å¹³å‡å€¼

---

## æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

### æµ‹è¯•æ‰§è¡Œè®°å½•

| æµ‹è¯•ç”¨ä¾‹ | æ‰§è¡Œæ—¥æœŸ | æ‰§è¡Œäºº | ç»“æœ | å¤‡æ³¨ |
|---------|---------|--------|------|------|
| TC-DB-001 | 2025-11-11 | AI | âœ… PASS | è¡¨åˆ›å»ºæˆåŠŸ |
| TC-DB-002 | 2025-11-11 | AI | âœ… PASS | Cookieå¯¼å…¥æˆåŠŸ |
| TC-DB-003 | 2025-11-11 | AI | âœ… PASS | Bucketåˆ›å»ºæˆåŠŸ |
| TC-EF-001 | 2025-11-11 | AI | â¸ï¸ PENDING | å¾…éƒ¨ç½² |
| ... | ... | ... | ... | ... |

### Bugè®°å½•

| Bug ID | ä¸¥é‡ç¨‹åº¦ | æè¿° | çŠ¶æ€ | ä¿®å¤æ–¹æ¡ˆ |
|--------|---------|------|------|---------|
| BUG-001 | High | TikHub CloudflareéªŒè¯è¶…æ—¶ | Open | å¢åŠ è¶…æ—¶æ—¶é—´åˆ°40ç§’ |
| BUG-002 | Medium | æˆªå›¾æ–‡ä»¶è¿‡å¤§ | Fixed | é™ä½qualityåˆ°80 |

### æµ‹è¯•è¦†ç›–ç‡

- **æ•°æ®åº“**: 100% (3/3 æµ‹è¯•é€šè¿‡)
- **Edge Functions**: 83% (5/6 æµ‹è¯•é€šè¿‡ï¼Œ1ä¸ªpending)
- **å‰ç«¯**: 80% (4/5 æµ‹è¯•é€šè¿‡)
- **å®šæ—¶ä»»åŠ¡**: 67% (2/3 æµ‹è¯•é€šè¿‡)
- **é›†æˆæµ‹è¯•**: 67% (2/3 æµ‹è¯•é€šè¿‡)

**æ€»ä½“è¦†ç›–ç‡**: 79.3%

## æµ‹è¯•ç¯å¢ƒæ¸…ç†

æµ‹è¯•å®Œæˆåæ‰§è¡Œï¼š

```sql
-- åˆ é™¤æµ‹è¯•æ•°æ®
DELETE FROM keep_monitor_records WHERE site_slug = 'test';
DELETE FROM keep_monitor_cookies WHERE site_slug = 'test';
DELETE FROM keep_monitor_sites WHERE slug = 'test';

-- åˆ é™¤æµ‹è¯•æˆªå›¾
-- åœ¨Supabase Storage Dashboardæ‰‹åŠ¨åˆ é™¤test/ç›®å½•
```

