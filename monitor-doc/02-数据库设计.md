# 数据库设计文档

## 表结构定义

### 1. keep_monitor_sites (网站监控配置表)

```sql
CREATE TABLE keep_monitor_sites (
  id bigserial PRIMARY KEY,
  name text NOT NULL,                    -- 网站名称（如：OpenRouter）
  slug text UNIQUE NOT NULL,             -- 唯一标识（如：openrouter）
  url text NOT NULL,                     -- 访问URL
  scraper_config jsonb NOT NULL,         -- 抓取配置（YAML转JSON）
  is_active boolean DEFAULT true,        -- 是否启用
  display_order int DEFAULT 0,           -- 显示顺序
  icon_url text,                         -- 网站图标URL
  description text,                      -- 网站描述
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- 索引
CREATE INDEX idx_monitor_sites_active ON keep_monitor_sites(is_active, display_order);

-- 注释
COMMENT ON TABLE keep_monitor_sites IS '费用监控网站配置表';
COMMENT ON COLUMN keep_monitor_sites.slug IS '唯一标识符，用于URL路径和文件命名';
COMMENT ON COLUMN keep_monitor_sites.scraper_config IS 'YAML配置转换的JSON，包含抓取步骤';
```

### 2. keep_monitor_cookies (Cookie存储表)

```sql
CREATE TABLE keep_monitor_cookies (
  id bigserial PRIMARY KEY,
  site_slug text REFERENCES keep_monitor_sites(slug) ON DELETE CASCADE,
  cookies jsonb NOT NULL,                -- Cookie数组（JSON格式）
  is_valid boolean DEFAULT true,         -- Cookie是否有效
  last_validated_at timestamptz,         -- 最后验证时间
  expires_at timestamptz,                -- 过期时间（从Cookie中解析）
  validation_error text,                 -- 验证失败原因
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(site_slug)
);

-- 索引
CREATE INDEX idx_monitor_cookies_validation ON keep_monitor_cookies(is_valid, expires_at);

-- 注释
COMMENT ON TABLE keep_monitor_cookies IS 'Cookie存储表，每个网站一条记录';
COMMENT ON COLUMN keep_monitor_cookies.cookies IS 'Cookie数组，格式参考浏览器导出的JSON';
COMMENT ON COLUMN keep_monitor_cookies.is_valid IS '自动更新：抓取成功=true，失败=false';
```

### 3. keep_monitor_records (监控数据记录表)

```sql
CREATE TABLE keep_monitor_records (
  id bigserial PRIMARY KEY,
  site_slug text REFERENCES keep_monitor_sites(slug) ON DELETE CASCADE,
  data jsonb NOT NULL,                   -- 抓取的数据（灵活结构）
  screenshot_url text,                   -- 截图URL（Storage路径）
  scrape_duration int,                   -- 抓取耗时（毫秒）
  status text CHECK (status IN ('success', 'failed', 'cookie_invalid')),
  error_message text,                    -- 错误信息
  trigger_source text DEFAULT 'auto',    -- 触发来源：auto/manual
  created_at timestamptz DEFAULT now(),
  
  -- 索引优化
  INDEX idx_site_date (site_slug, created_at DESC),
  INDEX idx_status (status, created_at DESC)
);

-- 注释
COMMENT ON TABLE keep_monitor_records IS '监控数据记录表，每次抓取产生一条记录';
COMMENT ON COLUMN keep_monitor_records.trigger_source IS 'auto=定时任务，manual=手动触发';
COMMENT ON COLUMN keep_monitor_records.data IS '抓取的数据，结构根据网站不同而不同';

-- 自动清理旧数据（保留30天）
CREATE OR REPLACE FUNCTION cleanup_old_monitor_records()
RETURNS void AS $$
BEGIN
  DELETE FROM keep_monitor_records
  WHERE created_at < NOW() - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;
```

## 数据格式示例

### keep_monitor_sites.scraper_config 格式

```json
{
  "name": "OpenRouter",
  "url": "https://openrouter.ai/settings/credits",
  "steps": [
    {
      "action": "navigate",
      "url": "{{url}}",
      "wait_for": "networkidle",
      "comment": "访问Credits页面，等待网络空闲"
    },
    {
      "action": "wait",
      "selector": "text=/Credits|\\$/",
      "timeout": 10000,
      "comment": "等待包含'Credits'或'$'的文本出现，最多等10秒"
    },
    {
      "action": "extract",
      "name": "credits",
      "selector": "text=/\\$\\s*([\\d.]+)/",
      "type": "regex",
      "group": 1,
      "transform": "float",
      "comment": "提取美元金额，正则匹配'$ 7.73'格式，转换为浮点数"
    },
    {
      "action": "screenshot",
      "full_page": false,
      "comment": "截取当前可见区域的截图"
    }
  ],
  "validation": {
    "cookie_check": {
      "selector": "button:has-text('Sign Out')",
      "comment": "检测是否存在'Sign Out'按钮，存在表示已登录"
    }
  }
}
```

### keep_monitor_cookies.cookies 格式

```json
[
  {
    "name": "__session",
    "value": "eyJhbGciOiJSUzI1NiIs...",
    "domain": ".openrouter.ai",
    "path": "/",
    "expires": 1794375607,
    "httpOnly": true,
    "secure": true,
    "sameSite": "lax"
  },
  {
    "name": "_ga",
    "value": "GA1.1.277555034.1760316792",
    "domain": ".openrouter.ai",
    "path": "/",
    "expires": 1797399585,
    "httpOnly": false,
    "secure": false
  }
]
```

### keep_monitor_records.data 格式

**OpenRouter:**
```json
{
  "credits": 7.73,
  "currency": "USD",
  "scraped_at": "2025-11-11T09:00:00Z"
}
```

**TikHub:**
```json
{
  "balance": 9.0416,
  "free_credit": 0.0006,
  "daily_cost": 0.0020,
  "api_requests_today": 2,
  "last_check_in": "2025-06-05",
  "scraped_at": "2025-11-11T09:00:00Z"
}
```

**Cursor:**
```json
{
  "included_usage": {
    "used": 87,
    "total": 500,
    "percentage": 17.4
  },
  "on_demand_usage": {
    "spent": 1,
    "limit": 10,
    "currency": "USD",
    "percentage": 10
  },
  "reset_date": "2025-12-04",
  "scraped_at": "2025-11-11T09:00:00Z"
}
```

## RLS (Row Level Security) 策略

### keep_monitor_sites
```sql
-- 所有人可读
CREATE POLICY "Anyone can view sites"
  ON keep_monitor_sites FOR SELECT
  USING (true);

-- 只有service_role可写
CREATE POLICY "Only service role can modify sites"
  ON keep_monitor_sites FOR ALL
  USING (auth.role() = 'service_role');
```

### keep_monitor_cookies
```sql
-- 只有service_role可访问（保护敏感数据）
CREATE POLICY "Only service role can access cookies"
  ON keep_monitor_cookies FOR ALL
  USING (auth.role() = 'service_role');
```

### keep_monitor_records
```sql
-- 所有人可读最新记录
CREATE POLICY "Anyone can view recent records"
  ON keep_monitor_records FOR SELECT
  USING (created_at > NOW() - INTERVAL '7 days');

-- 只有service_role可写
CREATE POLICY "Only service role can insert records"
  ON keep_monitor_records FOR INSERT
  WITH CHECK (auth.role() = 'service_role');
```

## 初始化数据

### 插入OpenRouter配置
```sql
INSERT INTO keep_monitor_sites (name, slug, url, scraper_config, display_order, icon_url, description)
VALUES (
  'OpenRouter',
  'openrouter',
  'https://openrouter.ai/settings/credits',
  '{"见网站配置YAML文档"}',
  1,
  'https://openrouter.ai/favicon.ico',
  'AI API聚合平台，监控Credits余额'
);
```

### 插入TikHub配置
```sql
INSERT INTO keep_monitor_sites (name, slug, url, scraper_config, display_order, icon_url, description)
VALUES (
  'TikHub',
  'tikhub',
  'https://user.tikhub.io/en-us/users/overview',
  '{"见网站配置YAML文档"}',
  2,
  'https://user.tikhub.io/favicon.ico',
  'TikTok数据API，监控账户余额和每日消耗'
);
```

### 插入Cursor配置
```sql
INSERT INTO keep_monitor_sites (name, slug, url, scraper_config, display_order, icon_url, description)
VALUES (
  'Cursor',
  'cursor',
  'https://cursor.com/dashboard',
  '{"见网站配置YAML文档"}',
  3,
  'https://cursor.com/favicon.ico',
  'AI编程工具，监控请求配额和费用'
);
```

## 数据维护

### 查询最新记录
```sql
-- 获取每个网站的最新记录
SELECT DISTINCT ON (site_slug)
  site_slug,
  data,
  screenshot_url,
  status,
  created_at
FROM keep_monitor_records
ORDER BY site_slug, created_at DESC;
```

### 更新Cookie有效性
```sql
-- Edge Function会自动更新，也可手动更新
UPDATE keep_monitor_cookies
SET 
  is_valid = false,
  validation_error = 'Cookie已过期',
  last_validated_at = NOW()
WHERE site_slug = 'openrouter';
```

### 清理测试数据
```sql
-- 删除测试记录
DELETE FROM keep_monitor_records
WHERE status = 'failed' AND created_at < NOW() - INTERVAL '1 day';
```

