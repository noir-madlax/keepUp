<template>
  <!-- Ê†πÂÆπÂô® -->
  <div class="min-h-screen">
    
    <!-- Âä†ËΩΩÁä∂ÊÄÅÊòæÁ§∫ -->
    <LoadingSpinner v-if="isLoading" />

    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
  <header class="fixed top-0 left-0 right-0 bg-white z-40 w-full">
      <!-- ÂØºËà™Ê†èÂÜÖÂÆπÂÆπÂô® -->
      <div class="flex justify-between items-center px-4 h-[90px] min-w-[320px] max-w-[1440px] mx-auto">
        <!-- Â∑¶‰æßLogoÂíåÊ†áÈ¢òÂÆπÂô® -->
        <div class="flex flex-col flex-shrink-0">
          <div class="flex items-center gap-2">
            <!-- ÁΩëÁ´ôLogoÂõæÁâá -->
            <img 
              src="/images/icons/logo.svg" 
              alt="Keep Up Logo" 
              class="w-[36px] h-[36px] sm:w-[48px] sm:h-[48px] flex-shrink-0" 
            />
            <!-- ÁΩëÁ´ôÊ†áÈ¢òÊñáÊú¨ -->
            <h1 class="text-[16px] sm:text-[20px] text-[#333333] font-[400] leading-6 font-['PingFang_SC'] flex items-center gap-2 whitespace-nowrap">
              {{ t('home.title') }}
              <span class="inline-block px-1.5 py-0.5 bg-gradient-to-r from-pink-500 to-purple-500 text-white text-xs rounded-full font-medium transform hover:scale-105 transition-transform">
                BETA
              </span>
            </h1>
          </div>
        </div>

     <!-- 2024-03-19: Early AccessÊ®™ÂπÖ - ‰ªÖÂú®Ê°åÈù¢Á´ØÊòæÁ§∫Âú®ÂØºËà™Ê†è‰∏≠ -->
     <div class="hidden sm:block bg-white py-2 text-center text-pink-500 font-medium relative -ml-20">
      <div 
          class="cursor-pointer group"
          @click="feedbackStore.showForm()"
        >
          <p class="text-base animate-bounce  text-pink-500 ">
            <span class="">üì® Dear early adopters, </span>
            <span class="text-blue-500 font-medium group-hover:text-blue-600 transition-colors">Click here</span>
            <span class=""> to share your feedback and shape our future!</span>
            <span class="ml-1 inline-block animate-bounce">üì®</span>
          </p>
        </div>
      </div>
        
        <!-- Âè≥‰æßÂØºËà™ÂÖÉÁ¥†ÂÆπÂô® -->
        <div class="flex items-center gap-1 pl-2">
          <!-- Â∑≤ÁôªÂΩïÁî®Êà∑‰ø°ÊÅØÂå∫Âüü -->
          <template v-if="authStore.isAuthenticated">
            <!-- Áî®Êà∑Â§¥ÂÉè -->
            <img 
              :src="authStore.user?.user_metadata?.avatar_url || '/images/icons/avatar.svg'" 
              :alt="authStore.user?.email || 'User Avatar'" 
              class="w-[24px] h-[24px] rounded-full flex-shrink-0"
            />
            <!-- ÁôªÂá∫ÊåâÈíÆ - Â¢ûÂä†ÊúÄÂ∞èÂÆΩÂ∫¶Á°Æ‰øùÊñáÂ≠óÂÆåÊï¥ÊòæÁ§∫ -->
            <button 
              @click="handleLogout" 
              class="text-gray-600 hover:text-gray-800 min-w-[48px] sm:min-w-[64px] h-[32px] text-center text-sm sm:text-base whitespace-nowrap"
            >
              {{ t('home.nav.logout') }}
            </button>
          </template>

          <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅÊòæÁ§∫ -->
          <template v-else>
            <button 
              @click="showLoginModal = true"
              class="w-[32px] h-[32px] flex items-center justify-center"
            >
              <img 
                src="/images/icons/login.svg" 
                alt="Login"
                class="w-[32px] h-[32px]"
              />
            </button>
          </template>
        </div>
      </div>
      
      <!-- ÂàÜÂâ≤Á∫ø -->
      <div class="h-[1px] hidden bg-[#E5E5E5] w-full"></div>
</header>

    <!-- ÁôªÂΩïÊ®°ÊÄÅÊ°Ü -->
    <login-modal 
      v-if="showLoginModal" 
      @close="handleLoginModalClose" 
      @success="handleLoginSuccess"
      :allowClose="authStore.isAuthenticated"
      class="z-50"
    />

    <!-- Ê∑ªÂä† ArticleRequestForm ÁªÑ‰ª∂Âà∞È°∂Â±Ç -->
    <ArticleRequestForm 
      ref="articleRequestFormRef" hidden
      @refresh="handleArticleRefresh"
      @uploadSuccess="handleUploadSuccess"
      @clearInput="handleClearInput"
    />

    <!-- Âè™Âú®ÈùûÂä†ËΩΩÁä∂ÊÄÅ‰∏ãÊòæÁ§∫‰∏ªË¶ÅÂÜÖÂÆπ -->
    <template v-if="!isLoading">
      <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü - Êñ∞Áî®Êà∑Â∏ÉÂ±Ä -->
      <template v-if="isNewUser">
        <div class="flex flex-col items-center justify-center min-h-screen px-4 pt-[90px]">
          <!-- ‰∫ßÂìÅÊ†áËØ≠ÂíåÁâπÁÇπ -->
          <div class="text-center mb-8">
            <h2 class="text-3xl sm:text-4xl font-bold mb-6 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent flex items-center justify-center gap-2">
              Quick Video & Audio Summary
              <span class="hidden sm:inline-block px-1.5 py-0.5 bg-gradient-to-r from-pink-500 to-purple-500 text-white text-xs rounded-full font-medium transform hover:scale-105 transition-transform">
                BETA
              </span>
            </h2>
            <div class="max-w-2xl mx-auto space-y-4">
              <p class="text-lg sm:text-xl text-gray-700">
                Transform long videos and podcasts into concise summariesÔºÅ
              </p>
              <div class="flex flex-wrap justify-center gap-6 mt-6">
                <!-- ‰∫ßÂìÅÁâπÁÇπ -->
                <div class="flex items-center gap-2">
                  <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span>Quick Summaries</span>
                </div>
                <div class="flex items-center gap-2">
                  <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span>Multiple Platforms</span>
                </div>
                <div class="flex items-center gap-2">
                  <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span>AI Chat & Analysis</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Êñ∞Áî®Êà∑ Âπ≥Âè∞ÂõæÊ†á -->
          <div class="flex justify-center items-center gap-6 mb-6">
            <img 
              v-for="channel in ['youtube', 'apple-podcast', 'spotify']"
              :key="channel"
              :src="`/images/icons/${channel}.svg`"
              :alt="channel"
              class="w-8 h-8 sm:w-10 sm:h-10 transform hover:scale-110 transition-all duration-300"
            />
          </div>

          <!-- Êñ∞Áî®Êà∑‰∏ä‰º†Êù° -->
          <div class="w-full max-w-3xl mx-auto px-4">
            <UploadInput
              v-model="requestUrl"
              container-class="relative"
              input-class="w-full h-12 sm:h-14 px-6 pr-14 rounded-full border-2 border-gray-200 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 bg-white text-gray-800 placeholder-gray-400 transition-all duration-300 text-base sm:text-lg"
              enter-icon-class="absolute right-4 top-1/2 transform -translate-y-1/2 w-6 h-6 sm:w-8 sm:h-8 opacity-80 hover:opacity-100 transition-all duration-200 cursor-pointer"
              @submit="handleSubmit"
              @showLogin="showLoginModal = true"
            />
          </div>
        </div>
      </template>

      <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü - ËÄÅÁî®Êà∑Â∏ÉÂ±Ä -->
      <template v-else>
        <pull-to-refresh class="mt-[20px]" :onRefresh="handleRefresh">
          <div class="px-4 sm:px-8 py-2 overflow-x-hidden">
            <div class="max-w-screen-2xl mx-auto w-full px-2 sm:px-0">
              <div class="flex flex-wrap items-center gap-2 sm:gap-4 mb-3 p-3 sm:p-4 bg-white rounded-lg sm:rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-200">
                <div class="flex items-center gap-4 w-full">
                  <div class="flex items-center gap-2 sm:gap-3">
                    <img 
                      v-for="channel in ['youtube', 'apple-podcast', 'spotify']"
                      :key="channel"
                      :src="`/images/icons/${channel}.svg`"
                      :alt="channel"
                      class="w-4 h-4 sm:w-6 sm:h-6"
                    />
                  </div>

                  <p class="text-sm bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent font-medium animate-pulse whitespace-nowrap">
                    Quick video & audio summary
                  </p>
                </div>

                <div class="relative flex-grow w-full">
                  <UploadInput
                    v-model="requestUrl"
                    container-class="relative flex-grow w-full"
                    input-class="w-full sm:flex-grow pl-3 pr-12 py-2.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-000 focus:border-transparent bg-gray-100 transition-all duration-300"
                    enter-icon-class="absolute right-3 sm:right-4 top-1/2 transform -translate-y-1/2 w-6 h-6 sm:w-8 sm:h-8 opacity-100 transition-opacity duration-200 cursor-pointer hover:scale-110 transition-transform"
                    @submit="handleSubmit"
                    @showLogin="showLoginModal = true"
                  />
                </div>
              </div>
      <!-- ÊñáÂ≠óÂå∫Âüü- ËÄÅÁî®Êà∑Â∏ÉÂ±Ä  -->
              <div class="articles-section">
                <div class="flex justify-between items-center mb-[10px]">
                  <!-- ÊñáÁ´†Ê†áÈ¢ò -->
                  <h2 class="font-['PingFang_SC'] text-[20px] font-semibold leading-[28px] text-[#000000]">
                    {{ t('home.articles.title') }}
                  </h2>
                  
                </div>
                <!-- ÊñáÁ´†ÂàóË°® -->
                <div class="articles-grid">
                  <template v-if="filteredArticles.length > 0">
                    <ArticleCard
                      v-for="article in filteredArticles"
                      :key="'requestId' in article ? article.requestId : article.id"
                      :article="article"
                      @delete="deleteRequest"
                    />
                  </template>

                 
                  <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                  <template v-if="isLoading">
                    <div v-for="n in 27" :key="n" 
                      class="card-container"
                    >
                      <div class="flex flex-col h-full w-full gap-3">
                        <div class="flex justify-between gap-3">
                          <div class="flex flex-col gap-2 flex-1">
                            <div class="h-6 bg-gray-200 rounded w-4/5"></div>
                            <div class="h-6 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-6 bg-gray-200 rounded w-2/3"></div>
                          </div>
                          <div class="w-[120px] h-[120px] bg-gray-200 rounded-xl flex-shrink-0"></div>
                        </div>

                        <div class="h-[1px] bg-gray-200 w-full"></div>

                        <div class="flex justify-between items-center">
                          <div class="flex items-center gap-2">
                            <div class="w-5 h-5 bg-gray-200 rounded-full"></div>
                            <div class="h-4 bg-gray-200 rounded w-20"></div>
                          </div>
                          <div class="flex items-center gap-2">
                            <div class="w-5 h-5 bg-gray-200 rounded"></div>
                            <div class="h-4 bg-gray-200 rounded w-20"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>

              <!-- Âä†ËΩΩÊõ¥Â§ö -->
              <div v-if="authStore.isAuthenticated && (isLoading || hasMore)" class="text-center py-4">
                <div v-if="isLoading" class="flex justify-center items-center space-x-2">
                  <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                  <span class="text-gray-500">Loading more...</span>
                </div>
                <div v-else-if="hasMore" class="text-gray-500">
                  Scroll to load more
                </div>
              </div>
            </div>
          </div>
        </pull-to-refresh>
      </template>
    </template>

    <!-- 2024-03-24: Ê∑ªÂä†ÁßªÂä®Á´ØÂõ∫ÂÆöÂú®Âè≥‰∏ãËßíÁöÑÂèçÈ¶àÊåâÈíÆ -->
    <div 
      class="sm:hidden fixed bottom-12 right-0 z-[1002] cursor-pointer"
      @click="feedbackStore.showForm()"
    >
      <div class="bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-full px-4 py-2 shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center w-[90px] h-[36px]">
        <span class="text-sm font-medium whitespace-nowrap">Feedback</span>
      </div>
    </div>

    <!-- 2024-03-24: Ê∑ªÂä†ÂèçÈ¶àË°®ÂçïÁªÑ‰ª∂ -->
    <FeedbackForm 
      :is-visible="feedbackStore.showFeedbackForm"
      @close="feedbackStore.closeFeedbackForm"
      @submit="handleFeedbackSubmit"
      class="z-[1003]"
    />
  </div>
</template>
<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, onActivated, nextTick } from 'vue'
import ArticleCard from '../components/ArticleCard.vue'
import { supabase } from '../supabaseClient'
import { ElMessage } from 'element-plus'
import { useAuthStore } from '../stores/auth'
import LoginModal from '../components/LoginModal.vue'
import type { Article as ArticleType, ArticleStatus } from '../types/article'
import ArticleRequestForm from '../components/ArticleRequestForm.vue'
import { useI18n } from 'vue-i18n'
import PullToRefresh from '../components/PullToRefresh.vue'
import localforage from 'localforage'
import FeedbackForm from '@/components/feedback/FeedbackForm.vue'
import { useFeedbackStore } from '../stores/feedback'
import UploadInput from '../components/UploadInput.vue'
import LoadingSpinner from '../components/LoadingSpinner.vue'

const authStore = useAuthStore()
const showLoginModal = ref(false)
const showUploadModal = ref(false)
const selectedTag = ref<string>('all')
const selectedChannels = ref<string[]>([])
const selectedAuthors = ref<number[]>([])
const requestUrl = ref('')


// Ê∑ªÂä†Á±ªÂûãÂÆö‰πâ
interface Author {
  id: number
  name: string
  icon?: string
}

interface ArticleRequest {
  id: string
  url: string
  status: 'processing' | 'processed' | 'failed'
  created_at: string
  error_message?: string
  original_url: string
  platform?: string
  requestId?: string
  article_id?: string
}

interface OptimisticCard {
  id: string
  url: string
  original_url: string
  created_at: string
  status: 'processing'
  platform?: string
  requestId: string
}

interface KeepArticleView {
  article_id: string
  created_at: string
  is_author: boolean
  article: {
    id: string
    title: string
    cover_image_url?: string
    channel?: string
    created_at: string
    tags?: string[]
    publish_date?: string
    author_id?: number
    content?: string | null
    original_link?: string | null
    author?: Author
  }
}



// ‰øÆÊîπÂèòÈáèÂÆö‰πâ
const articles = ref<(ArticleType | ArticleRequest)[]>([])
const optimisticCards = ref<OptimisticCard[]>([])
const authors = ref<Author[]>([])

// ÂàÜÈ°µÁõ∏ÂÖ≥ÁöÑÁä∂ÊÄÅ
const pageSize = 18 // ÊØèÂä†ËΩΩÁöÑÊñáÁ´†Êï∞Èáè
const currentPage = ref(1)
const isLoading = ref(false) // Âä†ËΩΩÁä∂ÊÄÅ
const hasMore = ref(true) // Âê¶ËøòÊúâÊõ¥Â§öÊï∞ÊçÆ

// Ê∑ªÂä†ÈáçÁΩÆÂáΩÊï∞
const resetPageState = async () => {
  currentPage.value = 1
  articles.value = []
  hasMore.value = true
  await fetchArticles(true) // ÈáçÊñ∞Ëé∑ÂèñÁ¨¨È°µÊï∞ÊçÆ
}

// ÁõëË∑ØÁî±ÊøÄÊ¥ª
onActivated(() => {
  resetPageState()
})

// Ê∑ªÂä†‰∏™ÊÄßÊù•Âà§Êñ≠ÊòØÂê¶ÊúâÁ≠õÈÄâÊù°‰ª∂
const hasFilters = computed(() => {
  return selectedTag.value !== 'all' || 
         selectedChannels.value.length > 0 || 
         selectedAuthors.value.length > 0
})

// Ê∑ªÂä†ËΩÆËØ¢Áõ∏ÂÖ≥ÁöÑÂèòÈáè
const POLL_INTERVAL = 15000  // 15ÁßíËΩÆËØ¢‰∏ÄÊ¨°
let pollTimer: NodeJS.Timeout | null = null

// ‰øÆÊîπËΩÆËØ¢ÊéßÂà∂ÂáΩÊï∞
const startPolling = () => {
  if (pollTimer) return
  
  pollTimer = setInterval(async () => {
    try {
      // Ëé∑ÂèñÊâÄÊúâÂ§ÑÁêÜ‰∏≠ÁöÑËØ∑Ê±ÇID
      const processingIds = [
        ...articles.value
          .filter(article => 'status' in article && article.status === 'processing')
          .map(article => 'requestId' in article ? article.requestId : null),
        ...optimisticCards.value.map(card => card.requestId)
      ].filter(Boolean) as string[]

      // 2024-03-24: Â¶ÇÊûúÊ≤°ÊúâÂ§ÑÁêÜ‰∏≠ÁöÑËØ∑Ê±ÇÔºåÂÅúÊ≠¢ËΩÆËØ¢Âπ∂ËøîÂõû
      if (processingIds.length === 0) {
        stopPolling()
        return
      }

      // Êü•ËØ¢Ëøô‰∫õËØ∑Ê±ÇÁöÑÊúÄÊñ∞Áä∂ÊÄÅ
      const { data: updatedRequests } = await supabase
        .from('keep_article_requests')
        .select('*')
        .in('id', processingIds)

      if (!updatedRequests) return

      // Êõ¥Êñ∞Áä∂ÊÄÅ
      let hasProcessedItems = false
      const typedRequests = updatedRequests as unknown as {
        id: string
        original_url: string
        status: ArticleStatus
        created_at: string
        error_message?: string
        platform?: string
        article_id?: string
      }[]
      
      typedRequests.forEach(request => {
        if (request.status === 'processed') {
          hasProcessedItems = true
          // ÁßªÈô§ÂØπÂ∫îÁöÑ‰πêËßÇÊõ¥Êñ∞Âç°Áâá
          optimisticCards.value = optimisticCards.value.filter(
            card => card.requestId !== request.id
          )
          // ÁßªÈô§ÂØπÂ∫îÁöÑÂ§ÑÁêÜ‰∏≠ÊñáÁ´†
          articles.value = articles.value.filter(
            article => !('requestId' in article) || article.requestId !== request.id
          )
        } else if (request.status === 'failed') {
          // ÂØπ‰∫éÂ§±Ë¥•ÁöÑËØ∑Ê±ÇÔºåÊõ¥Êñ∞Áé∞ÊúâÁöÑËØ∑Ê±ÇÁä∂ÊÄÅ
          const index = articles.value.findIndex(
            article => 'requestId' in article && article.requestId === request.id
          )
          if (index !== -1) {
            const failedRequest = {
              ...articles.value[index],
              status: 'failed' as const,
              error_message: request.error_message,
              url: (articles.value[index] as ArticleRequest).url,
              original_url: (articles.value[index] as ArticleRequest).original_url
            } as ArticleRequest
            articles.value[index] = failedRequest
          }
          // ÁßªÈô§ÂØπÂ∫îÁöÑ‰πêËßÇÊõ¥Êñ∞Âç°Áâá
          optimisticCards.value = optimisticCards.value.filter(
            card => card.requestId !== request.id
          )
        }
      })

      // Âè™ÊúâÂΩìÊúâÂ§ÑÁêÜÂÆåÊàêÁöÑÈ°πÁõÆÊó∂ÔºåÊâçÂà∑Êñ∞ÊñáÁ´†ÂàóË°®Ëé∑ÂèñÊñ∞ÁöÑÊñáÁ´†
      if (hasProcessedItems) {
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ∑≤Â§ÑÁêÜÊñáÁ´†
        const { data: newArticles } = await supabase
          .from('keep_article_views')
          .select(`
            article_id,
            created_at,
            is_author,
            article:keep_articles(
              id,
              title,
              cover_image_url,
              channel,
              created_at,
              tags,
              publish_date,
              author_id,
              content,
              original_link,
              author:keep_authors(id, name, icon)
            )
          `)
          .eq('user_id', authStore.user?.id)
          .order('created_at', { ascending: false })
          .limit(pageSize)

        if (newArticles) {
          // Â§ÑÁêÜÊñ∞ÊñáÁ´†Êï∞ÊçÆ
          const validNewArticles = ((newArticles || []) as unknown as KeepArticleView[]).map(view => ({
            ...view.article,
            is_author: view.is_author,
            status: 'processed' as const,
            content: view.article?.content || '',
            original_link: view.article?.original_link || ''
          })).filter((article): article is ArticleType => 
            article !== null && 
            typeof article.is_author === 'boolean' && 
            article.status === 'processed' &&
            typeof article.content === 'string' &&
            typeof article.original_link === 'string'
          )

          // ‰øùÁïôÁé∞ÊúâÁöÑÂ§ÑÁêÜ‰∏≠ÂíåÂ§±Ë¥•Áä∂ÊÄÅÁöÑËØ∑Ê±Ç
          const existingRequests = articles.value.filter(
            article => 'status' in article && 
            (article.status === 'processing' || article.status === 'failed')  // 2024-03-24: ÊòéÁ°Æ‰øùÁïôÂ§±Ë¥•Áä∂ÊÄÅ
          )

          // ÂêàÂπ∂Êñ∞ÊñáÁ´†ÂíåÁé∞ÊúâÁöÑËØ∑Ê±Ç
          articles.value = [...existingRequests, ...validNewArticles]
        }
      }
    } catch (error) {
      console.error('ËΩÆËØ¢Êõ¥Êñ∞Â§±Ë¥•:', error)
    }
  }, POLL_INTERVAL)
}

const stopPolling = () => {
  if (pollTimer) {
    clearInterval(pollTimer)
    pollTimer = null
  }
}

// ‰øÆÊîπ addOptimisticCard ÂáΩÊï∞
const addOptimisticCard = async (url: string) => {
  // ÂÖàÁ´ãÂç≥Ê∑ªÂä†‰πêËßÇÊõ¥Êñ∞Âç°Áâá
  const now = new Date().toISOString()
  const id = `temp-${now}`
  const card: OptimisticCard = {
    id,
    url,
    original_url: url,
    created_at: now,
    status: 'processing',
    requestId: id,
    platform: getPlatformFromUrl(url)
  }
  
  // Ê∑ªÂä†‰πêËßÇÊõ¥Êñ∞Âç°Áâá
  optimisticCards.value = [card, ...optimisticCards.value]
  
  // Áî±‰∫éÊ∑ªÂä†‰∫ÜÂç°ÁâáÔºåisNewUser ËÆ°ÁÆóÂ±ûÊÄß‰ºöËá™Âä®Êõ¥Êñ∞ÔºåËß¶ÂèëÁïåÈù¢ÂàáÊç¢
  // ÂºÄÂßãËΩÆËØ¢
  startPolling()

  try {
    // ÂºÇÊ≠•Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®Áõ∏ÂêåURLÁöÑËØ∑Ê±Ç
    const { data: existingRequest } = await supabase
      .from('keep_article_requests')
      .select('*')
      .or(`url.eq.${url},original_url.eq.${url}`)
      .single()

    if (existingRequest) {
      // Â¶ÇÊûúÂ∑≤Â≠òÂú®ËØ∑Ê±ÇÔºåÁßªÈô§‰πêËßÇÊõ¥Êñ∞Âç°Áâá
      optimisticCards.value = optimisticCards.value.filter(c => c.id !== id)

      // Â¶ÇÊûúÊòØÂ§ÑÁêÜ‰∏≠Áä∂ÊÄÅÔºåÊ∑ªÂä†Âà∞ÊñáÁ´†ÂàóË°®
      const typedRequest = existingRequest as unknown as {
        id: string
        original_url: string
        status: ArticleStatus
        created_at: string
        error_message?: string
        platform?: string
        article_id?: string
      }
      
      if (typedRequest.status === 'processing') {
        const request = {
          id: typedRequest.id,
          url: typedRequest.original_url,
          status: typedRequest.status,
          created_at: typedRequest.created_at,
          error_message: typedRequest.error_message,
          original_url: typedRequest.original_url,
          platform: typedRequest.platform,
          article_id: typedRequest.article_id,
          requestId: typedRequest.id
        } as ArticleRequest

        articles.value = [request, ...articles.value]
      }
    }
  } catch (error) {
    console.error('Ê£ÄÊü•Â∑≤Â≠òÂú®ËØ∑Ê±ÇÂ§±Ë¥•:', error)
  }
}

// ‰ªéURLÂà§Êñ≠Âπ≥Âè∞
const getPlatformFromUrl = (url: string): string => {
  if (url.includes('youtube') || url.includes('youtu.be')) {
    return 'youtube'
  }
  if (url.includes('spotify')) {
    return 'spotify'
  }
  if (url.includes('podcasts.apple.com')) {
    return 'apple'
  }
  return 'webpage'
}


// ‰øÆÊîπ fetchArticles ÂáΩÊï∞
const fetchArticles = async (isRefresh = false) => {
  if (!authStore.isAuthenticated) return
  
  try {
    isLoading.value = true
    if (isRefresh) {
      currentPage.value = 1
    }

    // ÊûÑÂª∫Êü•ËØ¢
    const { data: views, error } = await supabase 
      .from('keep_article_views')
      .select(`
        article_id,
        created_at,
        is_author,
        article:keep_articles(
          id,
          title,
          cover_image_url,
          channel,
          created_at,
          tags,
          publish_date,
          author_id,
          content,
          original_link,
          author:keep_authors(id, name, icon)
        )
      `)
      .eq('user_id', authStore.user?.id)
      .order('created_at', { ascending: false })
      .range((currentPage.value - 1) * pageSize, currentPage.value * pageSize - 1)

    if (error) throw error

    // ‰øÆÊîπÔºöÊØèÊ¨°Âà∑Êñ∞ÊàñÁ¨¨‰∏ÄÈ°µÂä†ËΩΩÊó∂ÈÉΩËé∑ÂèñÂ§ÑÁêÜ‰∏≠ÂíåÂ§±Ë¥•ÁöÑËØ∑Ê±Ç
    let requests: any[] = []
    if (isRefresh || currentPage.value === 1) {
      const { data: requestsData } = await supabase 
        .from('keep_article_requests')
        .select('*')
        .eq('user_id', authStore.user?.id)
        .in('status', ['processing', 'failed'] as ArticleStatus[])
        .order('created_at', { ascending: false })
      
      requests = requestsData || []
    }

    // Â§ÑÁêÜÊñáÁ´†Êï∞ÊçÆ
    const validArticles = ((views || []) as unknown as KeepArticleView[]).map(view => ({
      ...view.article,
      is_author: view.is_author,
      status: 'processed' as const,
      content: view.article?.content || '',
      original_link: view.article?.original_link || ''
    })).filter((article): article is ArticleType => 
      article !== null && 
      typeof article.is_author === 'boolean' && 
      article.status === 'processed' &&
      typeof article.content === 'string' &&
      typeof article.original_link === 'string'
    )

    // ‰øÆÊîπËØ∑Ê±ÇÁöÑÁ±ªÂûãÂ§ÑÁêÜ
    const typedRequests = requests.map(request => ({
      id: request.id,
      url: request.original_url,
      status: request.status || 'processing',
      created_at: request.created_at || new Date().toISOString(),
      error_message: request.error_message,
      original_url: request.original_url,
      platform: request.platform,
      article_id: request.article_id,
      requestId: request.id
    } as ArticleRequest))
    
    // ÂêàÂπ∂ÊñáÁ´†ÂàóË°®
    if (isRefresh || currentPage.value === 1) {
      // Â¶ÇÊûúÊòØÂà∑Êñ∞ÊàñÁ¨¨‰∏ÄÈ°µÔºåÂåÖÂê´Â§ÑÁêÜ‰∏≠ÂíåÂ§±Ë¥•ÁöÑËØ∑Ê±Ç
      articles.value = [...typedRequests, ...validArticles]
    } else {
      // Â¶ÇÊûúÊòØÂä†ËΩΩÊõ¥Â§öÔºåÂè™Ê∑ªÂä†Êñ∞ÁöÑÊñáÁ´†
      articles.value = [...articles.value, ...validArticles]
    }
    
    // Êõ¥Êñ∞‰πêËßÇÊõ¥Êñ∞Âç°Áâá
    optimisticCards.value = optimisticCards.value.filter(opt => {
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÂØπÂ∫îÁöÑËØ∑Ê±ÇÂ∑≤ÁªèÂ≠òÂú®
      const hasMatchingRequest = articles.value.some(article => 
        'original_url' in article && 
        (article.original_url === opt.original_url || article.url === opt.original_url)
      )
      // Â¶ÇÊûúÂ≠òÂú®ÂåπÈÖçÁöÑËØ∑Ê±ÇÔºåÁßªÈô§‰πêËßÇÊõ¥Êñ∞Âç°Áâá
      return !hasMatchingRequest
    })

    // Êõ¥Êñ∞ÊòØÂê¶ËøòÊúâÊõ¥Â§öÊï∞ÊçÆ
    hasMore.value = hasFilters.value ? false : validArticles.length === pageSize

    // Âè™Âú®ÂÆåÊï¥Âà∑Êñ∞Êó∂Êõ¥Êñ∞ÁºìÂ≠ò
    if (isRefresh) {
      await localforage.setItem('articles-cache', validArticles)
    }

  } catch (error) {
    console.error('Ëé∑ÂèñÊñáÁ´†ÂàóË°®Â§±Ë¥•:', error)
    ElMessage.error('get article list failed ,please try again later')
  } finally {
    isLoading.value = false
  }
}

// ‰øÆÊîπ filteredArticles ËÆ°ÁÆóÂ±ûÊÄß
const filteredArticles = computed(() => {
  let result = [...optimisticCards.value, ...articles.value]


  return result
})

// ‰øÆÊîπÂà†Èô§ËØ∑Ê±ÇÁöÑÊñπÊ≥ï
const deleteRequest = async (requestId: string) => {
  try {
    const { error } = await supabase
      .from('keep_article_requests')
      .delete()
      .eq('id', requestId)

    if (error) throw error

    // ‰ªéÂàóË°®‰∏≠ÁßªÈô§ËØ•È°π
    articles.value = articles.value.filter(article => 
      !('requestId' in article) || article.requestId !== requestId
    )
    
    // ÂêåÊó∂Ê∏ÖÁêÜÂØπÂ∫îÁöÑ‰πêËßÇÊõ¥Êñ∞Âç°Áâá
    optimisticCards.value = optimisticCards.value.filter(opt => 
      opt.requestId !== requestId
    )
    
    ElMessage.success(t('upload.message.deleteSuccess'))
  } catch (error) {
    console.error('Âà†Èô§ËØ∑Ê±ÇÂ§±Ë¥•:', error)
    ElMessage.error(t('upload.message.deleteFailed'))
  }
}

// ‰øÆÊîπÁªÑ‰ª∂Âç∏ËΩΩÊó∂ÁöÑÊ∏ÖÁêÜ
onUnmounted(() => {
  window.removeEventListener('scroll', handleScroll)
  stopPolling()
})


// ‰øÆÊîπÁôªÂΩïÊàêÂäüÁöÑÂ§ÑÁêÜÂáΩÊï∞
const handleLoginSuccess = async () => {
  showLoginModal.value = false
  
  try {
    await authStore.loadUser()
    
    if (!authStore.user?.id) {
      console.error('[handleLoginSuccess] User information not loaded properly')
      return
    }
    
    await fetchArticles()
    
    // Â§ÑÁêÜÂæÖ‰∏ä‰º†ÁöÑURL
    const pendingUrl = localStorage.getItem('pendingUploadUrl')
    if (pendingUrl && articleRequestFormRef.value && authStore.isAuthenticated) {
      articleRequestFormRef.value.quickSubmit(pendingUrl)
      localStorage.removeItem('pendingUploadUrl')
    }
  } catch (error) {
    console.error('[handleLoginSuccess] Error:', error)
    ElMessage.error(t('error.loginFailed'))
  }
}

// ‰øÆÊîπ onMounted Èí©Â≠ê
onMounted(async () => {
  console.log('[onMounted] Component mounting, auth status:', authStore.isAuthenticated)
  
  // ÂÖàÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
  await authStore.loadUser()
  console.log('[onMounted] User loaded, new auth status:', authStore.isAuthenticated)
  
  if (!authStore.isAuthenticated) {
    showLoginModal.value = true
    // Êú™ÁôªÂΩïÊó∂Áõ¥Êé•ËøîÂõûÔºå‰∏çÊâßË°åÂêéÁª≠Êï∞ÊçÆËé∑Âèñ
    return
  }
  
  // Âè™Âú®ÁôªÂΩïÁä∂ÊÄÅ‰∏ãÊâßË°åÊï∞ÊçÆËé∑Âèñ
  console.log('[onMounted] User is authenticated, initializing data')

  try {
    // Ëé∑ÂèñÊñáÁ´†Âíå‰ΩúËÄÖÊï∞ÊçÆ
    await Promise.all([
      fetchArticles()
    ])
  } catch (error) {
    console.error('[onMounted] Error loading data:', error)
  } finally {
  }
  

  // Ê∑ªÂä†ÊªöÂä®ÁõëÂê¨
  window.addEventListener('scroll', handleScroll)

  // Ê£ÄÊü•ÊòØÂê¶ÊúâÂæÖÂ§ÑÁêÜÁöÑURL
  const pendingUrl = localStorage.getItem('pendingUploadUrl')
  if (pendingUrl && authStore.isAuthenticated) {
    // Á≠âÂæÖÁªÑ‰ª∂ÂÆåÂÖ®ÊåÇËΩΩ
    await nextTick()
    
    // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁôªÂΩï‰∏îÁªÑ‰ª∂Â∑≤ÊåÇËΩΩÔºåÂàôÊâìÂºÄ‰∏ä‰º†modal
  }
})


const handleLogout = async () => {
  try {
    console.log('[handleLogout] Starting logout process')
    
    // 2024-03-15: ÂÖàÊ∏ÖÁ©∫Êú¨Âú∞Êï∞ÊçÆ
    articles.value = []
    authors.value = []
    selectedAuthors.value = []
    selectedChannels.value = []
    currentPage.value = 1
    hasMore.value = true
    isLoading.value = false
    
    
    // ÊâßË°åÁôªÂá∫
    await authStore.signOut()
    ElMessage.success(t('auth.logoutSuccessMessage'))
    
  } catch (error) {
    console.error('[handleLogout] Error:', error)
    ElMessage.error(t('auth.logoutFailedMessage'))
  }
}


const { t } = useI18n()




// Ê∑ªÂä†ÊªöÂä®Âä†ËΩΩÂ§ÑÁêÜÂáΩÊï∞
const handleScroll = () => {
  // 2024-03-15: Êú™ÁôªÂΩïÁî®Êà∑‰∏çÊâßË°åÊªöÂä®Âä†ËΩΩ
  if (!authStore.isAuthenticated) return
  
  // Ëé∑ÂèñÊªöÂÆπ
  const container = document.documentElement
  
  // ËÆ°ÁÆóË∑ùÁ¶ªÂ∫ïÈÉ®ÁöÑË∑ùÁ¶ª
  const bottomOfWindow = container.scrollHeight - container.scrollTop - container.clientHeight
  
  // ÂΩìË∑ùÁ¶ªÂ∫ïÈÉ®100pxÊó∂Âä†ËΩΩÊõ¥Â§ö
  if (bottomOfWindow < 100 && !isLoading.value && hasMore.value) {
    currentPage.value++
    fetchArticles()
  }
}

// ‰øÆÊîπ PullToRefresh ÁªÑ‰ª∂ÁöÑÂà∑Êñ∞Â§ÑÁêÜ
const handleRefresh = async () => {
  await fetchArticles(true) // ‰º†ÂÖ• true Ë°®Á§∫Âà∑Êñ∞
}

const articleRequestFormRef = ref<InstanceType<typeof ArticleRequestForm> | null>(null)


// Ê∑ªÂä†Êñ∞ÁöÑÂ§ÑÁêÜÂáΩÊï∞
const handleArticleRefresh = async () => {
  await fetchArticles(true)
}

// ‰øÆÊîπ handleUploadSuccess ÂáΩÊï∞
const handleUploadSuccess = (url: string) => {
  addOptimisticCard(url)
  // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
  handleClearInput()
  // ÂºÄÂßãËΩÆËØ¢Êõ¥Êñ∞Áä∂ÊÄÅ
  startPolling()
}



// Ê∑ªÂä†Â§ÑÁêÜÂáΩÊï∞
const handleClearInput = () => {
  requestUrl.value = ''
  // ÁßªÈô§ËæìÂÖ•Ê°ÜÁÑ¶ÁÇπ
  const inputElement = document.querySelector('input[type="text"]') as HTMLInputElement
  if (inputElement) {
    inputElement.blur()
  }
}

// Âú®script setupÈÉ®ÂàÜÊ∑ªÂä†handleLoginModalCloseÂáΩÊï∞
const handleLoginModalClose = () => {
  // 2024-03-21: Âè™ÊúâÂú®Â∑≤ÁôªÂΩïÁä∂ÊÄÅ‰∏ãÊâçÂÖÅËÆ∏ÂÖ≥Èó≠ÁôªÂΩïÊ°Ü
  if (authStore.isAuthenticated) {
    showLoginModal.value = false
  }
}

// Ê∑ªÂä†ÂèçÈ¶àË°®ÂçïÁõ∏ÂÖ≥ÁöÑÁä∂ÊÄÅÂíåÊñπÊ≥ï
const feedbackStore = useFeedbackStore()

// Â§ÑÁêÜÂèçÈ¶àË°®ÂçïÊèê‰∫§
const handleFeedbackSubmit = (formData: {
  needProduct: boolean
  satisfiedSummary: boolean
  allowContact: boolean
}) => {
  console.log('Feedback submitted:', formData)
  feedbackStore.closeFeedbackForm()
  // TODO: ËøôÈáåÂêéÁª≠‰ºöÊ∑ªÂä†ÂèëÈÄÅÂà∞ÂêéÁ´ØÁöÑÈÄªËæë
}


// Âú® script setup ÈÉ®ÂàÜÊ∑ªÂä†
const isNewUser = computed(() => {
  // Âú®Âä†ËΩΩÁä∂ÊÄÅ‰∏ãËøîÂõû nullÔºåÈÅøÂÖçÊòæÁ§∫‰ªª‰ΩïÂ∏ÉÂ±Ä
  if (isLoading.value) {
    return null
  }
  return articles.value.length === 0 && optimisticCards.value.length === 0
})

// ‰øÆÊîπ handleSubmit ÂáΩÊï∞
const handleSubmit = (url: string) => {
  if (articleRequestFormRef.value) {
    articleRequestFormRef.value.quickSubmit(url)
    handleClearInput()
  }
}
</script>

<style scoped>
/* Ê∑ªÂä†ÊªöÂä®Êù°Ê†∑Âºè */
.overflow-y-auto {
  scrollbar-width: thin;
  scrollbar-color: #CBD5E0 #EDF2F7;
}

.overflow-y-auto::-webkit-scrollbar {
  width: 8px;
}

.overflow-y-auto::-webkit-scrollbar-track {
  background: #EDF2F7;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
  background-color: #CBD5E0;
  border-radius: 4px;
}

/* Ê∑ªÂä†ÂÆπÂô®ËøáÊ∏°Âä®Áîª */
.my-uploads-section {
  transition: all 0.3s ease;
}

.articles-section {
  width: 100% !important;
  max-width: 1440px;
  margin: 0 auto;
}

.articles-grid {
  display: grid;
  gap: 28px;
  width: 100%;
  margin: 0 auto;
}

/* Âú®Ê°åÈù¢Á´ØÊó∂Âº∫Âà∂ÊòæÁ§∫3ÂàóÔºåÂπ∂ËÆæÁΩÆÂêàÈÄÇÁöÑÂàó */
@media (min-width: 1199px) {
  .articles-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Âú®‰∏≠Á≠âÂ±èÂπï‰∏äÊòæÁ§∫2Âàó */
@media (min-width: 900px) and (max-width: 1200px) {
  .articles-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Âú®ÁßªÂä®Á´ØÊòæÁ§∫1Âàó */
@media (max-width: 450px) {
  .articles-grid {
    grid-template-columns: 1fr;
  }
}

/* Á°Æ‰øùÊû∂ÂõæÂç°Áâá‰∏éÂÆûÈôÖÊñáÁ´†Âç°ÁâáÊ†∑Âºè‰∏ÄËá¥ */
.article-card {
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* ‰øùÊåÅÂéüÊúâÁöÑÁΩëÊ†ºÂ∏ÉÂ±ÄÊ†∑Âºè */
.articles-grid {
  display: grid;
  gap: 28px;
  width: 100%;
  margin: 0 auto;
}

/* Ê∑ªÂä†È™®Êû∂Â±èÂç°ÁâáÊ†∑Âºè */
.card-container {
  display: flex;
  width: 100%;
  min-width: 340px;
  max-width: 450px;
  height: 190px;
  padding: 12px;
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
  border-radius: 12px;
  border: 1px solid #F2F2F2;
  background: #FFF;
  box-shadow: 0px 0px 8px 0px rgba(0, 0, 0, 0.10);
}

@media (min-width: 400px) {
  .card-container [class*="w-[120px]"] {
    width: 190px;
  }
}

/* Ê∑ªÂä†È™®Êû∂Â±èÂä®Áîª */
.bg-gray-200 {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: .5;
  }
}

/* 2024-03-21: Ê∑ªÂä†ÁôªÂΩïmodalÁöÑz-indexÊ†∑Âºè */
:deep(.login-modal) {
  z-index: 9999;
}

/* 2024-03-21: Á°Æ‰øùÂÖ∂‰ªñfixedÂÖÉÁ¥†ÁöÑz-index‰Ωé‰∫émodal */
.fixed {
  z-index: 40;
}

/* Ê∑ªÂä†ÂèçÈ¶àË°®ÂçïÂÆπÂô®Ê†∑Âºè */
.feedback-container {
  display: inline-block;
  position: relative;
}

/* 2024-03-22: Ê∑ªÂä†ËæìÂÖ•Ê°ÜÈ´ò‰∫ÆÂä®Áîª */
.input-highlight::placeholder {
  animation: textHighlight 1s ease-out;
  color: #3B82F6;
}

@keyframes textHighlight {
  0% {
    opacity: 0.3;
    transform: scale(1);
  }
  50% {
    opacity: 1;
    transform: scale(1.5);
  }
  100% {
    opacity: 0.3;
    transform: scale(1);
  }
}

/* 2024-03-22: ‰øÆÊîπplaceholderÊñáÂ≠óÂä®Áîª */
input::placeholder {
  transition: all 0.3s ease;
}

/* Ê∑ªÂä†Á©∫Áä∂ÊÄÅÂç°ÁâáÊ†∑Âºè */
.empty-article-card {
  display: flex;
  width: 100%;
  min-width: 340px;
  max-width: 450px;
  height: 190px;
  padding: 12px;
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
  border-radius: 12px;
  border: 1px solid #F2F2F2;
  background: #FFF;
  box-shadow: 0px 0px 8px 0px rgba(0, 0, 0, 0.10);
  cursor: pointer;
  transition: all 0.3s ease;
}

.empty-article-card:hover {
  transform: translateY(-2px);
  box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.15);
}

.empty-article-card .divider {
  width: 100%;
  height: 0;
  border-top: 1px solid #EEE;
  margin: 0;
}

.empty-article-card .card-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  height: 24px;
}

.empty-article-card .author-info {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 0;
}

.empty-article-card .channel-date {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-right: 8px;
}

.empty-article-card .channel-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

/* Ê∑ªÂä†Êñ∞ÁöÑÊ†∑Âºè */
.channel-icon {
  @apply w-6 h-6 transition-transform duration-300;
}

.channel-icon:hover {
  @apply transform scale-110;
}

/* Ê∑ªÂä†Êñ∞ÁöÑÊ†∑Âºè */
input::placeholder {
  color: #9CA3AF;
}

input:focus::placeholder {
  color: #6B7280;
}

/* ËæìÂÖ•Ê°ÜËÅöÁÑ¶Êó∂ÁöÑÈò¥ÂΩ±ÊïàÊûú */
input:focus {
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Âπ≥Âè∞ÂõæÊ†áÊÇ¨ÂÅúÊïàÊûú */
img.transform:hover {
  filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
}
</style>

